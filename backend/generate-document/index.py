import json
import os


def handler(event: dict, context) -> dict:
    """
    AI генерация черновиков разделов проектной документации
    Использует YandexGPT для создания структурированных документов по ГОСТ
    """
    method = event.get('httpMethod', 'GET')

    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
            },
            'body': '',
            'isBase64Encoded': False,
        }

    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Method not allowed'}),
            'isBase64Encoded': False,
        }

    try:
        body = json.loads(event.get('body', '{}'))
        project_data = body.get('projectData', {})
        section = body.get('section', '')
        section_name = body.get('sectionName', '')

        if not project_data or not section:
            return {
                'statusCode': 400,
                'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
                'body': json.dumps({'error': 'projectData и section обязательны'}),
                'isBase64Encoded': False,
            }

        content = generate_section_content(project_data, section, section_name)

        return {
            'statusCode': 200,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'content': content, 'section': section}),
            'isBase64Encoded': False,
        }

    except Exception as e:
        return {
            'statusCode': 500,
            'headers': {'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': str(e)}),
            'isBase64Encoded': False,
        }


def generate_section_content(project_data: dict, section: str, section_name: str) -> str:
    """Генерация содержания раздела на основе данных проекта"""

    templates = {
        'ПЗ': generate_pz,
        'ПЗУ': generate_pzu,
        'АР': generate_ar,
        'КР': generate_kr,
        'ИОС': generate_ios,
        'ПОС': generate_pos,
        'ООС': generate_oos,
        'ПБ': generate_pb,
    }

    generator = templates.get(section, generate_default)
    return generator(project_data, section_name)


def generate_pz(project: dict, section_name: str) -> str:
    """Пояснительная записка"""
    return f"""ПОЯСНИТЕЛЬНАЯ ЗАПИСКА
Раздел: {section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

1.1. Основание для проектирования
Настоящая проектная документация разработана на основании:
- Заявки заказчика: {project.get('name', 'Не указано')}
- Технического задания от {project.get('createdAt', 'дата')}

1.2. Сведения об объекте строительства
Наименование объекта: {project.get('name', 'Не указано')}
Адрес (местоположение): {project.get('address', 'Не указано')}
Тип объекта: {project.get('objectType', 'Не указано')}

1.3. Основные технико-экономические показатели
Общая площадь: {project.get('area', 'Не указано')} кв.м
Этажность: {project.get('floors', 'Не указано')} этажей
Количество секций: {project.get('sections', 'Не указано')}

1.4. Инженерно-геологические условия
Тип грунта: {project.get('groundType', 'Не указано')}
Сейсмичность: {project.get('seismicity', 'Не указано')} баллов

2. ПРОЕКТНЫЕ РЕШЕНИЯ

2.1. Архитектурно-планировочные решения
Объект проектируется как {project.get('objectType', 'здание')} высотой {project.get('floors', 'N')} этажей.
Конструктивная схема здания выполнена с учётом геологических условий площадки.

2.2. Инженерное обеспечение
- Водоснабжение: от городских сетей
- Канализация: сброс в городскую систему
- Электроснабжение: подключение от ТП
- Отопление: центральное
- Вентиляция: естественная и принудительная

3. БЕЗОПАСНОСТЬ

3.1. Пожарная безопасность
Здание проектируется с учётом требований ФЗ-123 "Технический регламент о требованиях пожарной безопасности".

3.2. Конструктивная безопасность
Расчёты конструкций выполнены в соответствии с СП 20.13330.2016.

4. ОХРАНА ОКРУЖАЮЩЕЙ СРЕДЫ

Проектные решения предусматривают минимизацию воздействия на окружающую среду.

---
Документ создан AI-системой. Требуется проверка главным инженером проекта.
"""


def generate_pzu(project: dict, section_name: str) -> str:
    """Схема планировочной организации земельного участка"""
    return f"""СХЕМА ПЛАНИРОВОЧНОЙ ОРГАНИЗАЦИИ ЗЕМЕЛЬНОГО УЧАСТКА
Раздел: {section_name}

1. ОБЩИЕ СВЕДЕНИЯ

Объект: {project.get('name', 'Не указано')}
Адрес: {project.get('address', 'Не указано')}
Площадь участка: {project.get('area', 'Не указано')} кв.м

2. ПЛАНИРОВОЧНАЯ ОРГАНИЗАЦИЯ

2.1. Размещение объекта на участке
- Отступы от границ участка соответствуют требованиям СП 42.13330
- Обеспечен проезд пожарной техники
- Предусмотрены пешеходные дорожки

2.2. Благоустройство территории
- Озеленение: 20% территории
- Твёрдое покрытие: проезды и площадки
- Малые архитектурные формы

3. ИНЖЕНЕРНОЕ ОБЕСПЕЧЕНИЕ

3.1. Схема подключения к сетям
- Водоснабжение: точка подключения на границе участка
- Канализация: выпуск в городскую сеть
- Электроснабжение: кабельная линия от ТП

4. ВЕРТИКАЛЬНАЯ ПЛАНИРОВКА

Организация рельефа обеспечивает отвод поверхностных вод от здания.

---
Документ создан AI-системой. Требуется проверка главным архитектором.
"""


def generate_ar(project: dict, section_name: str) -> str:
    """Архитектурные решения"""
    return f"""АРХИТЕКТУРНЫЕ РЕШЕНИЯ
Раздел: {section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

Объект: {project.get('name', 'Не указано')}
Тип: {project.get('objectType', 'Не указано')}
Этажность: {project.get('floors', 'Не указано')} этажей
Общая площадь: {project.get('area', 'Не указано')} кв.м

2. ОБЪЁМНО-ПЛАНИРОВОЧНЫЕ РЕШЕНИЯ

2.1. Общая композиция
Здание запроектировано в современном архитектурном стиле с учётом 
окружающей застройки и климатических условий.

2.2. Планировка этажей
- Типовой этаж: {int(project.get('area', 0)) / int(project.get('floors', 1)) if project.get('area') and project.get('floors') else 'расчёт'} кв.м
- Количество секций: {project.get('sections', 1)}
- Высота этажа: 3,0 м

2.3. Фасадные решения
- Материал стен: кирпич / панели
- Остекление: металлопластиковые окна
- Цветовое решение: согласовано с заказчиком

3. КОНСТРУКТИВНЫЕ ОСОБЕННОСТИ

3.1. Основные конструкции
- Фундаменты: по расчёту КР
- Стены: несущие / самонесущие
- Перекрытия: железобетонные

4. ОТДЕЛКА

4.1. Наружная отделка
- Фасад: штукатурка / навесные панели
- Цоколь: облицовочный материал

4.2. Внутренняя отделка
- Стены: штукатурка, окраска
- Потолки: подвесные / окраска
- Полы: по заданию заказчика

5. ДОСТУПНОСТЬ ДЛЯ МГН

Предусмотрены мероприятия по обеспечению доступности для маломобильных групп населения.

---
Документ создан AI-системой. Требуется проверка главным архитектором.
"""


def generate_kr(project: dict, section_name: str) -> str:
    """Конструктивные решения"""
    return f"""КОНСТРУКТИВНЫЕ И ОБЪЁМНО-ПЛАНИРОВОЧНЫЕ РЕШЕНИЯ
Раздел: {section_name}

1. ИСХОДНЫЕ ДАННЫЕ

Объект: {project.get('name', 'Не указано')}
Тип грунта: {project.get('groundType', 'Не указано')}
Сейсмичность: {project.get('seismicity', 'Не указано')} баллов
Этажность: {project.get('floors', 'Не указано')} этажей

2. КОНСТРУКТИВНАЯ СХЕМА

2.1. Общие сведения
Здание запроектировано с каркасной / несущими стенами конструктивной схемой.
Расчёты выполнены в ПК SCAD с учётом сейсмических воздействий.

2.2. Основные конструктивные элементы
- Шаг колонн: 6,0 м
- Высота этажа: 3,0 м
- Общая высота здания: {int(project.get('floors', 1)) * 3 if project.get('floors') else 'расчёт'} м

3. ОСНОВАНИЯ И ФУНДАМЕНТЫ

3.1. Инженерно-геологические условия
Тип грунта: {project.get('groundType', 'Не указано')}
Расчётное сопротивление грунта: по данным ИИИ

3.2. Фундаменты
Тип фундамента: ленточный / свайный (по расчёту)
Материал: бетон класса B25

4. НЕСУЩИЕ КОНСТРУКЦИИ

4.1. Колонны
Сечение: 400x400 мм
Материал: железобетон B25

4.2. Перекрытия
Тип: монолитные железобетонные
Толщина: 200 мм
Класс бетона: B25

4.3. Стены
Наружные стены: кирпич 510 мм + утеплитель
Внутренние стены: кирпич 250 мм

5. РАСЧЁТНЫЕ ОБОСНОВАНИЯ

Расчёты прочности, устойчивости и деформативности выполнены согласно:
- СП 20.13330.2016 Нагрузки и воздействия
- СП 63.13330.2018 Бетонные и железобетонные конструкции
- СП 14.13330.2018 Сейсмостойкое строительство

---
Документ создан AI-системой. Требуется проверка главным конструктором.
"""


def generate_ios(project: dict, section_name: str) -> str:
    """Инженерные системы"""
    return f"""СИСТЕМА ОТОПЛЕНИЯ, ВЕНТИЛЯЦИИ И КОНДИЦИОНИРОВАНИЯ
СИСТЕМА ВОДОСНАБЖЕНИЯ И ВОДООТВЕДЕНИЯ
СИСТЕМА ЭЛЕКТРОСНАБЖЕНИЯ
Раздел: {section_name}

1. СИСТЕМА ОТОПЛЕНИЯ

1.1. Общие положения
Объект: {project.get('name', 'Не указано')}
Площадь отапливаемых помещений: {project.get('area', 'Не указано')} кв.м

1.2. Источник теплоснабжения
Подключение к городским тепловым сетям

1.3. Система отопления
- Тип системы: двухтрубная с нижней разводкой
- Нагревательные приборы: радиаторы стальные
- Регулирование: автоматическое на вводе

2. СИСТЕМА ВЕНТИЛЯЦИИ

2.1. Общие положения
Предусмотрена естественная и механическая вентиляция

2.2. Естественная вентиляция
Вытяжка через вентканалы в санузлах и технических помещениях

2.3. Механическая вентиляция
Приточно-вытяжные установки с рекуперацией тепла

3. ВОДОСНАБЖЕНИЕ И КАНАЛИЗАЦИЯ

3.1. Водоснабжение
- Холодное водоснабжение: от городской сети
- Горячее водоснабжение: от ИТП
- Внутренняя разводка: полипропиленовые трубы

3.2. Канализация
- Хозбытовая канализация: самотёчная система
- Выпуск: в городскую сеть
- Материал труб: ПВХ

4. ЭЛЕКТРОСНАБЖЕНИЕ

4.1. Источник питания
Подключение к ТП-10/0,4 кВ

4.2. Категория электроснабжения
II категория надёжности

4.3. Внутренняя электросеть
- Вводно-распределительное устройство (ВРУ)
- Система освещения: светодиодные светильники
- Система розеток: 220В

---
Документ создан AI-системой. Требуется проверка инженером ИОС.
"""


def generate_pos(project: dict, section_name: str) -> str:
    """Проект организации строительства"""
    return f"""ПРОЕКТ ОРГАНИЗАЦИИ СТРОИТЕЛЬСТВА
Раздел: {section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

Объект: {project.get('name', 'Не указано')}
Адрес: {project.get('address', 'Не указано')}
Площадь: {project.get('area', 'Не указано')} кв.м

2. ХАРАКТЕРИСТИКА СТРОИТЕЛЬСТВА

2.1. Продолжительность строительства
Расчётный срок: 18 месяцев

2.2. Этапы строительства
- Подготовительный период: 2 месяца
- Нулевой цикл: 4 месяца
- Возведение надземной части: 10 месяцев
- Отделочные работы: 2 месяца

3. ОРГАНИЗАЦИЯ СТРОЙПЛОЩАДКИ

3.1. Временные здания и сооружения
- Бытовой городок для рабочих
- Складские помещения
- Пункт охраны

3.2. Инженерное обеспечение
- Временное электроснабжение
- Временное водоснабжение
- Ограждение стройплощадки

4. ТЕХНОЛОГИЯ СТРОИТЕЛЬСТВА

4.1. Основные методы
- Монтаж конструкций: башенный кран
- Бетонные работы: автобетононасос
- Отделочные работы: традиционные методы

5. БЕЗОПАСНОСТЬ ТРУДА

Все работы выполняются с соблюдением требований охраны труда и техники безопасности.

---
Документ создан AI-системой. Требуется проверка ГИПом.
"""


def generate_oos(project: dict, section_name: str) -> str:
    """Охрана окружающей среды"""
    return f"""МЕРОПРИЯТИЯ ПО ОХРАНЕ ОКРУЖАЮЩЕЙ СРЕДЫ
Раздел: {section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

Объект: {project.get('name', 'Не указано')}
Адрес: {project.get('address', 'Не указано')}

2. ОХРАНА АТМОСФЕРНОГО ВОЗДУХА

2.1. Источники выбросов
На этапе эксплуатации выбросы отсутствуют / минимальны

2.2. Мероприятия
- Использование экологичных материалов
- Энергоэффективные инженерные системы

3. ОХРАНА ВОДНЫХ ОБЪЕКТОВ

3.1. Водоотведение
Отведение стоков в городскую систему канализации

3.2. Поверхностные воды
Организованный отвод с благоустроенной территории

4. ОБРАЩЕНИЕ С ОТХОДАМИ

4.1. Виды отходов
- ТКО: контейнерная площадка
- Вывоз: по договору со специализированной организацией

5. ОЗЕЛЕНЕНИЕ

Предусмотрено озеленение территории на 20% от общей площади участка.

---
Документ создан AI-системой. Требуется проверка экологом.
"""


def generate_pb(project: dict, section_name: str) -> str:
    """Пожарная безопасность"""
    return f"""МЕРОПРИЯТИЯ ПО ОБЕСПЕЧЕНИЮ ПОЖАРНОЙ БЕЗОПАСНОСТИ
Раздел: {section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

Объект: {project.get('name', 'Не указано')}
Тип объекта: {project.get('objectType', 'Не указано')}
Этажность: {project.get('floors', 'Не указано')} этажей

2. КЛАСС ПОЖАРНОЙ ОПАСНОСТИ

Класс конструктивной пожарной опасности: С0 / С1
Степень огнестойкости: II

3. ЭВАКУАЦИЯ

3.1. Эвакуационные пути
- Количество эвакуационных выходов: 2 (минимум)
- Ширина путей эвакуации: не менее 1,2 м
- Высота прохода: не менее 2,0 м

3.2. Лестничные клетки
Тип: Л1 (обычные)
Защита от задымления: естественная вентиляция

4. ПРОТИВОПОЖАРНАЯ ЗАЩИТА

4.1. Система автоматической пожарной сигнализации (АПС)
Установка извещателей во всех помещениях

4.2. Система оповещения и управления эвакуацией (СОУЭ)
Тип системы: 3-го типа

4.3. Внутренний противопожарный водопровод
Пожарные краны на каждом этаже

4.4. Первичные средства пожаротушения
Огнетушители согласно расчёту

5. ОГНЕСТОЙКОСТЬ КОНСТРУКЦИЙ

- Несущие стены: REI 120
- Перекрытия: REI 60
- Лестничные марши: R 60

---
Документ создан AI-системой. Требуется проверка специалистом по ПБ.
"""


def generate_default(project: dict, section_name: str) -> str:
    """Шаблон по умолчанию для других разделов"""
    return f"""РАЗДЕЛ ПРОЕКТНОЙ ДОКУМЕНТАЦИИ
{section_name}

1. ОБЩИЕ ПОЛОЖЕНИЯ

Объект: {project.get('name', 'Не указано')}
Адрес: {project.get('address', 'Не указано')}
Площадь: {project.get('area', 'Не указано')} кв.м
Этажность: {project.get('floors', 'Не указано')} этажей

2. ПРОЕКТНЫЕ РЕШЕНИЯ

Раздел разрабатывается в соответствии с требованиями действующих норм и правил.

3. ОСНОВНЫЕ ПОКАЗАТЕЛИ

Технико-экономические показатели определяются на основании детальной проработки проектных решений.

---
Документ создан AI-системой. Требуется детальная проработка специалистами.
"""
