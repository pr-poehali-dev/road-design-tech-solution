"""Генерация КП через ИИ — асинхронная очередь через БД, поллинг статуса"""
import json
import os
import base64
import io
import httpx
import psycopg2
import threading


def get_db():
    return psycopg2.connect(os.environ['DATABASE_URL'])


def extract_text_from_pdf(data: bytes) -> str:
    try:
        import pypdf
        reader = pypdf.PdfReader(io.BytesIO(data))
        texts = []
        for page in reader.pages:
            t = page.extract_text()
            if t:
                texts.append(t)
        return '\n'.join(texts)
    except Exception as e:
        return f'[Ошибка чтения PDF: {e}]'


def extract_text_from_docx(data: bytes) -> str:
    try:
        import docx
        doc = docx.Document(io.BytesIO(data))
        parts = []

        def get_cell_text(cell):
            return ' '.join(p.text.strip() for p in cell.paragraphs if p.text.strip())

        for block in doc.element.body:
            tag = block.tag.split('}')[-1] if '}' in block.tag else block.tag
            if tag == 'p':
                para = None
                for p in doc.paragraphs:
                    if p._element is block:
                        para = p
                        break
                if para and para.text.strip():
                    style = para.style.name if para.style else ''
                    if 'Heading' in style or 'heading' in style:
                        parts.append(f'\n## {para.text.strip()}')
                    else:
                        parts.append(para.text.strip())
            elif tag == 'tbl':
                for tbl in doc.tables:
                    if tbl._element is block:
                        rows = tbl.rows
                        if not rows:
                            continue
                        header_cells = [get_cell_text(c) for c in rows[0].cells]
                        has_header = any(header_cells)
                        if has_header:
                            parts.append('\nТАБЛИЦА:')
                            parts.append(' | '.join(header_cells))
                            parts.append('-' * 40)
                        for row in (rows[1:] if has_header else rows):
                            row_texts = [get_cell_text(c) for c in row.cells]
                            non_empty = [t for t in row_texts if t]
                            if non_empty:
                                if has_header:
                                    pairs = []
                                    for h, v in zip(header_cells, row_texts):
                                        if v:
                                            pairs.append(f'{h}: {v}' if h else v)
                                    parts.append(', '.join(pairs))
                                else:
                                    parts.append(' | '.join(non_empty))
                        break

        return '\n'.join(parts)
    except Exception as e:
        return f'[Ошибка чтения DOCX: {e}]'


PRICE_LIST = [
    {"code": "ОП-ОКС.БЗУ", "name": "Благоустройство земельного участка (БЗУ под ключ)", "unit": "га", "price_per_unit": 500000, "min_order_sum": 500000, "special_rules": "Округление площади: 1.1–1.4 как 1 га; 1.5–1.9 как 2 га"},
    {"code": "ОП-ППТ понижающие условия", "name": "ППТ, гос, понижающие условия", "unit": "га", "price_per_unit": 215000, "special_rules": "Коэффициент 0.15 для понижающих условий"},
    {"code": "ОП-ППТ госконтракт", "name": "ППТ, госконтракт", "unit": "га", "price_per_unit": 450000, "special_rules": "Коэффициент 0.3 для госконтрактов"},
    {"code": "ОП-ППТ коммерческий", "name": "ППТ, коммерческий контракт", "unit": "га", "price_per_unit": 1500000},
    {"code": "ОП-ПМТ понижающие условия", "name": "ПМТ, гос, понижающие условия", "unit": "га", "price_per_unit": 215000},
    {"code": "ОП-ПМТ госконтракт", "name": "ПМТ, госконтракт", "unit": "га", "price_per_unit": 450000},
    {"code": "ОП-ПМТ коммерческий", "name": "ПМТ, коммерческий контракт", "unit": "га", "price_per_unit": 1500000},
    {"code": "ИИ-ИГДИ", "name": "Инженерно-геодезические изыскания", "unit": "га", "price_per_unit": 40000},
    {"code": "ИИ-ИЭИ", "name": "Инженерно-экологические изыскания", "unit": "га", "price_per_unit": 65000},
    {"code": "ИИ-ОБМ", "name": "Обмерные работы (обследование строительных конструкций)", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ПГО до 100", "name": "ПГО до 100 га", "unit": "га", "price_per_unit": 24000},
    {"code": "ОП-ПГО 100-500", "name": "ПГО 100–500 га", "unit": "га", "price_per_unit": 23000},
    {"code": "ОП-ПГО 500-2000", "name": "ПГО 500–2000 га", "unit": "га", "price_per_unit": 22000},
    {"code": "ОП-ПГО 2000-5000", "name": "ПГО 2000–5000 га", "unit": "га", "price_per_unit": 21000},
    {"code": "ОП-ПГО более 5000", "name": "ПГО более 5000 га", "unit": "га", "price_per_unit": 20000},
    {"code": "ОП-ЛИК.КОНС.ГДП", "name": "Ликвидация/консервация/рекультивация горнодобывающих участков", "unit": "га", "price_per_unit": 100000},
    {"code": "СОПГЭ", "name": "Сопровождение экспертизы (ГЭ/НГЭ)", "unit": "комплект", "price_per_unit": 200000, "special_rules": "Может считаться по разделам по отдельному запросу"},
    {"code": "ОП-ЛО.НС.АД до 1000", "name": "Дорога НС, до 1000 м²", "unit": "м²", "price_per_unit": 700},
    {"code": "ОП-ЛО.НС.АД 1000-5000", "name": "Дорога НС, 1000–5000 м²", "unit": "м²", "price_per_unit": 600},
    {"code": "ОП-ЛО.НС.АД 5000-10000", "name": "Дорога НС, 5000–10000 м²", "unit": "м²", "price_per_unit": 550},
    {"code": "ОП-ЛО.НС.АД более 10000", "name": "Дорога НС, более 10000 м²", "unit": "м²", "price_per_unit": 500},
    {"code": "ОП-ЛО.РЕК.АД до 1000", "name": "Дорога реконструкция, до 1000 м²", "unit": "м²", "price_per_unit": 2000},
    {"code": "ОП-ЛО.РЕК.АД 1000-5000", "name": "Дорога реконструкция, 1000–5000 м²", "unit": "м²", "price_per_unit": 1400},
    {"code": "ОП-ЛО.РЕК.АД 5000-10000", "name": "Дорога реконструкция, 5000–10000 м²", "unit": "м²", "price_per_unit": 1200},
    {"code": "ОП-ЛО.РЕК.АД более 10000", "name": "Дорога реконструкция, более 10000 м²", "unit": "м²", "price_per_unit": 1000},
    {"code": "ОП-ОКС.НС.МОСТ", "name": "Мостовое сооружение, новое", "unit": "м²", "price_per_unit": 11000},
    {"code": "ОП-ОКС.РЕК.МОСТ", "name": "Мостовое сооружение, реконструкция", "unit": "м²", "price_per_unit": 9000},
    {"code": "ОП-ДП до 100", "name": "Дизайн-проект интерьеров до 100 м²", "unit": "м²", "price_per_unit": 5000},
    {"code": "ОП-ДП 100-200", "name": "Дизайн-проект 100–200 м²", "unit": "м²", "price_per_unit": 4000},
    {"code": "ОП-ДП 200-500", "name": "Дизайн-проект 200–500 м²", "unit": "м²", "price_per_unit": 3000},
    {"code": "ОП-ДП 500-1000", "name": "Дизайн-проект 500–1000 м²", "unit": "м²", "price_per_unit": 1000},
    {"code": "ОП-ОКС.НС до 100", "name": "ОКС — новое строительство, до 100 м³", "unit": "м³", "price_per_unit": 5000},
    {"code": "ОП-ОКС.НС 100-500", "name": "ОКС — новое строительство, 100–500 м³", "unit": "м³", "price_per_unit": 4000},
    {"code": "ОП-ОКС.НС 500-5000", "name": "ОКС — новое строительство, 500–5000 м³", "unit": "м³", "price_per_unit": 2000},
    {"code": "ОП-ОКС.НС более 5000", "name": "ОКС — новое строительство, более 5000 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.НС.СПиПП до 100", "name": "ОКС упрощённые — склады/производства, до 100 м³", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ОКС.НС.СПиПП 100-500", "name": "ОКС упрощённые — склады/производства, 100–500 м³", "unit": "м³", "price_per_unit": 400},
    {"code": "ОП-ОКС.НС.СПиПП 500-5000", "name": "ОКС упрощённые — склады/производства, 500–5000 м³", "unit": "м³", "price_per_unit": 200},
    {"code": "ОП-ОКС.НС.СПиПП более 5000", "name": "ОКС упрощённые — склады/производства, более 5000 м³", "unit": "м³", "price_per_unit": 150},
    {"code": "ОП-ОКС.РЕК до 100", "name": "ОКС — реконструкция, до 100 м³", "unit": "м³", "price_per_unit": 3000},
    {"code": "ОП-ОКС.РЕК 100-500", "name": "ОКС — реконструкция, 100–500 м³", "unit": "м³", "price_per_unit": 2500},
    {"code": "ОП-ОКС.РЕК 500-5000", "name": "ОКС — реконструкция, 500–5000 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.РЕК более 5000", "name": "ОКС — реконструкция, более 5000 м³", "unit": "м³", "price_per_unit": 1000},
    {"code": "ОП-ОКС.РЕН до 100", "name": "ОКС — реновация, до 100 м³", "unit": "м³", "price_per_unit": 3000},
    {"code": "ОП-ОКС.РЕН 100-500", "name": "ОКС — реновация, 100–500 м³", "unit": "м³", "price_per_unit": 2500},
    {"code": "ОП-ОКС.РЕН 500-5000", "name": "ОКС — реновация, 500–5000 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.РЕН более 5000", "name": "ОКС — реновация, более 5000 м³", "unit": "м³", "price_per_unit": 1000},
    {"code": "ОП-ОКС.КР до 100", "name": "ОКС — капитальный ремонт, до 100 м³", "unit": "м³", "price_per_unit": 2000},
    {"code": "ОП-ОКС.КР 100-500", "name": "ОКС — капитальный ремонт, 100–500 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.КР 500-5000", "name": "ОКС — капитальный ремонт, 500–5000 м³", "unit": "м³", "price_per_unit": 1000},
    {"code": "ОП-ОКС.КР более 5000", "name": "ОКС — капитальный ремонт, более 5000 м³", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ОКС.ТР до 100", "name": "ОКС — текущий ремонт, до 100 м³", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ОКС.ТР 100-500", "name": "ОКС — текущий ремонт, 100–500 м³", "unit": "м³", "price_per_unit": 450},
    {"code": "ОП-ОКС.ТР 500-5000", "name": "ОКС — текущий ремонт, 500–5000 м³", "unit": "м³", "price_per_unit": 300},
    {"code": "ОП-ОКС.ТР более 5000", "name": "ОКС — текущий ремонт, более 5000 м³", "unit": "м³", "price_per_unit": 250},
    {"code": "ОП-ЛО.ИЛО до 1000", "name": "Локальные очистные сооружения, до 1000 м³/сут", "unit": "м³/сутки", "price_per_unit": 2300, "min_order_sum": 1125000, "special_rules": "При расширении состава +100 руб/м³/сут"},
    {"code": "ОП-ЛО.ИЛО 1000-5000", "name": "Локальные очистные сооружения, 1000–5000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1900, "min_order_sum": 1125000},
    {"code": "ОП-ЛО.ИЛО 5000-10000", "name": "Локальные очистные сооружения, 5000–10000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1500, "min_order_sum": 1125000},
    {"code": "ОП-ЛО.ИЛО более 10000", "name": "Локальные очистные сооружения, более 10000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1100, "min_order_sum": 1125000},
    {"code": "ОП-АН", "name": "Авторский надзор", "unit": "месяц", "price_per_unit": 100000},
    {"code": "ОП-НТС", "name": "Научно-техническое сопровождение (НТС)", "unit": "месяц", "price_per_unit": 1500000},
    {"code": "ОП-ТНЗ 1 сотрудник", "name": "Технадзор/техсопровождение, 1 сотрудник", "unit": "чел.-месяц", "price_per_unit": 350000},
    {"code": "ОП-ТНЗ 2-5 сотрудников", "name": "Технадзор/техсопровождение, 2–5 сотрудников", "unit": "чел.-месяц", "price_per_unit": 300000},
    {"code": "ОП-ТНЗ 5-10 сотрудников", "name": "Технадзор/техсопровождение, 5–10 сотрудников", "unit": "чел.-месяц", "price_per_unit": 250000},
    {"code": "ОП-ТНЗ более 10 сотрудников", "name": "Технадзор/техсопровождение, более 10 сотрудников", "unit": "чел.-месяц", "price_per_unit": 200000},
    {"code": "ОП-ЮРЗ 1 сотрудник", "name": "Юридическое сопровождение, 1 юрист", "unit": "чел.-месяц", "price_per_unit": 300000},
    {"code": "ОП-ЮРЗ 2-5 сотрудников", "name": "Юридическое сопровождение, 2–5 юристов", "unit": "чел.-месяц", "price_per_unit": 250000},
    {"code": "ОП-ЮРЗ 5-10 сотрудников", "name": "Юридическое сопровождение, 5–10 юристов", "unit": "чел.-месяц", "price_per_unit": 200000},
]

PRICE_LIST_STR = json.dumps(PRICE_LIST, ensure_ascii=False)

KP_SYSTEM_PROMPT = f"""Ты — эксперт по составлению коммерческих предложений для проектно-инжиниринговой компании.
На основе предоставленных документов (ТЗ, технические задания, файлы) составь детальное Коммерческое Предложение (КП) на русском языке.

КРИТИЧЕСКИ ВАЖНО — ЗАПРЕЩЕНО:
❌ НЕ включай ОП-НТС (НТС, научно-техническое сопровождение) НИКОГДА, если в тексте ТЗ не написано буквально "НТС" или "научно-техническое сопровождение". Стеснённые условия, сложность объекта, особый контроль — НЕ являются основанием для НТС. Если сомневаешься — НЕ включай.

ПРАЙС-ЛИСТ компании (используй ТОЛЬКО эти позиции для расчёта стоимости):
{PRICE_LIST_STR}

АЛГОРИТМ СОСТАВЛЕНИЯ КП (выполняй строго по шагам):

ШАГ 1 — Извлечь из ТЗ ключевые параметры:
- Тип объекта и наименование
- Вид работ: новое строительство (НС) / реконструкция (РЕК) / капремонт (КР)
- Площадь участка изысканий в га (найди в ТЗ явно или рассчитай из размеров)
- Строительный объём новых/реконструируемых сооружений в м³ (найди или оцени по аналогам)
- Наличие требований к экспертизам (ГЭЭ, госэкспертиза)
- Наличие авторского надзора, НТС

ШАГ 2 — Подобрать позиции из прайса:

ИНЖЕНЕРНЫЕ ИЗЫСКАНИЯ — включай ВСЕ виды изысканий, которые упомянуты в ТЗ:
- ИИ-ИГДИ (геодезия): если в ТЗ есть ИГДИ → объём = площадь_га, цена = 40000/га. Всегда включать для строительных объектов!
- ИИ-ИЭИ (экология): если в ТЗ есть ИЭИ → объём = площадь_га, цена = 65000/га. Всегда включать!
- ИИ-ОБМ (обмерные работы): если в ТЗ есть обследование/обмеры существующих конструкций → объём = оцени в м³ по описанию сооружений, цена = 500/м³
- Инженерно-геологические (ИГИ): если упомянуты в ТЗ → позиции нет в прайсе, ставь ориентировочно 1 000 000 руб (notes: "ориентировочно, не в прайсе")
- Инженерно-гидрометеорологические (ИГМИ): если упомянуты → 500 000 руб (notes: "ориентировочно, не в прайсе")
- Археологические изыскания: если упомянуты → 2 000 000 руб (notes: "ориентировочно, не в прайсе, включает ГИКЭ и согласование с КГИОП")

ПРОЕКТИРОВАНИЕ ОКС:
- Новое строительство: выбери диапазон по volume_m3:
  * до 100 м³ → "ОП-ОКС.НС до 100", 5000 руб/м³
  * 100–500 м³ → "ОП-ОКС.НС 100-500", 4000 руб/м³
  * 500–5000 м³ → "ОП-ОКС.НС 500-5000", 2000 руб/м³
  * более 5000 м³ → "ОП-ОКС.НС более 5000", 1500 руб/м³
- Реконструкция: "ОП-ОКС.РЕК ..." соответствующий диапазон (до 100: 3000, 100-500: 2500, 500-5000: 1500, >5000: 1000)
- Капремонт: "ОП-ОКС.КР ..." (до 100: 2000, 100-500: 1500, 500-5000: 1000, >5000: 500)
- ВАЖНО: если volume_m3 не указан → ОЦЕНИ по типу объекта (НЕ СТАВЬ 0!):
  * Промышленные/технологические сооружения: ~20000-50000 м³
  * Административное здание: ~5000-10000 м³

ЭКСПЕРТИЗЫ:
- СОПГЭ: 1 комплект = 200000 руб — включать если требуется госэкспертиза ИЛИ ГЭЭ

ДОПОЛНИТЕЛЬНЫЕ (только если ЯВНО указано):
- ОП-АН (авторский надзор): объём = кол-во месяцев строительства, 100000/мес
- ОП-НТС: включать ТОЛЬКО если в ТЗ дословно написано "НТС" или "научно-техническое сопровождение". Если таких слов нет — ОП-НТС НЕ ВКЛЮЧАТЬ вообще.

ШАГ 3 — Рассчитать каждую строку:
total = volume × price_per_unit (ПРОВЕРИТЬ арифметику!)
Сумма в notes для позиций не из прайса.

ШАГ 4 — Посчитать total_sum:
Сложить ВСЕ строки total включая позиции не из прайса. Перепроверить сумму.

ЭТАЛОННЫЙ ПРИМЕР расчёта (объект 6.9 га, 25000 м³ НС, с ГЭЭ, с АН 18 мес, с ИГИ, ИГМИ, Арх):
- ИИ-ИГДИ: 6.9 × 40000 = 276000
- ИИ-ИЭИ: 6.9 × 65000 = 448500
- ИГИ (не в прайсе): 1000000 (ориентировочно)
- ИГМИ (не в прайсе): 500000 (ориентировочно)
- Археологические (не в прайсе): 2000000 (ориентировочно)
- ИИ-ОБМ: 2000 м³ × 500 = 1000000
- ОП-ОКС.НС более 5000: 25000 × 1500 = 37500000
- СОПГЭ: 1 × 200000 = 200000
- ОП-АН: 18 × 100000 = 1800000
- ИТОГО БАЗОВЫЙ = 5224500 (изыскания) + 37500000 (проектирование) + 200000 (экспертиза) = 42924500
- С АН = 42924500 + 1800000 = 44724500

СТРУКТУРА КП:
1. Титульная страница: название, клиент, дата, объект, вид работ, основание, источник финансирования
2. Краткое резюме: суть проекта 3-5 предложений
3. Разделы работ: "Инженерные изыскания", "Проектирование", "Сопровождение экспертиз", "Дополнительные услуги"
4. В каждом разделе — таблица: Код | Наименование | Ед. | Объём | Цена за ед. | Итого
5. Итоговая стоимость с разбивкой: базовый пакет и опции
6. Сроки реализации по этапам
7. Условия оплаты (аванс 40%, промежуточные платежи, финальный расчёт)
8. Особые условия и исключения

Отвечай ТОЛЬКО JSON в формате:
{{
  "kp": {{
    "title": "...",
    "client": "...",
    "date": "...",
    "object_name": "...",
    "work_type": "...",
    "summary": "...",
    "sections": [{{"name": "...", "items": [{{"code": "...", "name": "...", "unit": "...", "volume": 0, "price_per_unit": 0, "total": 0, "notes": "..."}}]}}],
    "total_sum": 0,
    "total_sum_words": "...",
    "timeline": [{{"phase": "...", "duration": "...", "description": "..."}}],
    "payment_conditions": ["..."],
    "special_conditions": ["..."],
    "validity": "30 дней"
  }}
}}"""

ROADMAP_SYSTEM_PROMPT = """Ты — главный инженер проекта (ГИП) с опытом 20+ лет. Составь дорожную карту ИСКЛЮЧИТЕЛЬНО проектно-изыскательских работ (ПИР) на основе предоставленного ТЗ и КП.

═══ ПРИНЦИПЫ ═══

1. ТОЛЬКО ПИР — никакого строительства, монтажа, закупок, пусконаладки, ввода в эксплуатацию. Это не наша зона ответственности.

2. РАЗДЕЛЫ ОПРЕДЕЛЯЮТСЯ ИЗ ТЗ — анализируй объект, его назначение, класс сложности и из этого выводи необходимые разделы по нормативам:
   - Постановление Правительства РФ № 87 (состав проектной документации)
   - ГОСТ Р 21.1101 (общие требования к проектной документации)
   - СП 11-110-99 (авторский надзор)
   - СП 47.13330.2016 (инженерные изыскания)
   - Отраслевые нормативы под объект (водоснабжение/канализация: СП 32, СП 31; энергетика: СП 256, ПУЭ; транспорт: СП 34, СП 35; промышленность: ГОСТ Р 55.0.00, и т.д.)

3. ЭТАПЫ дорожной карты = последовательные стадии ПИР для данного конкретного объекта:
   Например для очистных сооружений: Изыскания → Предпроектные проработки → ПД (с перечнем разделов по № 87) → ГЭ + ГЭЭ → РД → АН
   Для территориального планирования: ИГДИ + ИЭИ → ППТ/ПМТ → согласования → ГЭЭ
   Для объекта капстроительства: Изыскания → ПД → Экспертиза → РД → АН

4. В поле deliverables каждого этапа — КОНКРЕТНЫЕ документы и разделы по составу (например: "Раздел 1 ПЗ", "Раздел 5.1 АР", "Раздел 5.2 КР", "Технический отчёт по ИГИ", "Заключение ГЭЭ" и т.д.)

5. СРОКИ в месяцах (реалистичные):
   - Инженерные изыскания (ИГДИ, ИГИ, ИЭИ, ИГМИ): 2–5 мес
   - Предпроектные работы (ППТ, ПМТ, ПГО): 3–8 мес
   - ПД для линейных объектов: 6–18 мес
   - ПД для объектов капстроительства: 4–12 мес
   - ГЭ/НГЭ: 3–4 мес
   - ГЭЭ: 3–6 мес
   - РД: 4–10 мес
   - АН: параллельно со строительством (указать отдельной фазой)

6. Риски — исключительно проектные: несвоевременная выдача ТУ, замечания экспертизы, изменение задания заказчиком, дополнительные изыскания.

═══ ФОРМАТ ОТВЕТА — ТОЛЬКО JSON ═══
{
  "roadmap": {
    "project_name": "...",
    "total_duration": "...",
    "overview": "...",
    "phases": [
      {
        "id": 1,
        "name": "...",
        "duration": "...",
        "start_month": 1,
        "end_month": 3,
        "tasks": ["конкретная задача 1", "конкретная задача 2"],
        "deliverables": ["Конкретный документ/раздел 1", "Конкретный документ/раздел 2"],
        "responsible": "...",
        "section_codes": ["код раздела по ГОСТ или нормативу, если применимо"]
      }
    ],
    "milestones": [{"month": 3, "name": "...", "criteria": "..."}],
    "risks": [{"risk": "...", "probability": "высокая/средняя/низкая", "impact": "высокий/средний/низкий", "mitigation": "..."}],
    "team": [{"role": "...", "count": 1, "tasks": "..."}],
    "critical_path": ["..."]
  }
}"""


def call_ai(system_prompt: str, user_message: str, max_tokens: int = 8000) -> str:
    api_key = os.environ.get('OPENROUTER_API_KEY', '')
    response = httpx.post(
        'https://openrouter.ai/api/v1/chat/completions',
        headers={
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json',
        },
        json={
            'model': 'deepseek/deepseek-chat',
            'messages': [
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_message}
            ],
            'max_tokens': max_tokens,
            'temperature': 0.15,
        },
        timeout=240.0
    )
    result = response.json()
    if 'choices' not in result:
        error_msg = result.get('error', {}).get('message', str(result))
        raise Exception(f"OpenRouter error: {error_msg}")
    return result['choices'][0]['message']['content']


def extract_json(text: str) -> dict:
    text = text.strip()
    if '```json' in text:
        text = text.split('```json')[1].split('```')[0].strip()
    elif '```' in text:
        text = text.split('```')[1].split('```')[0].strip()
    return json.loads(text)


def update_job_stage(job_id: str, stage: str, stage_num: int, total_stages: int):
    """Обновить промежуточный статус этапа в БД для отображения прогресса на фронте"""
    conn = None
    try:
        conn = get_db()
        cur = conn.cursor()
        progress_info = json.dumps({
            'stage': stage,
            'stage_num': stage_num,
            'total_stages': total_stages
        }, ensure_ascii=False)
        cur.execute(
            "UPDATE kp_jobs SET progress=%s, updated_at=NOW() WHERE id=%s",
            (progress_info, job_id)
        )
        conn.commit()
    except Exception:
        pass
    finally:
        if conn:
            conn.close()


# ═══════════════════════════════════════════════════════════════════
# НОРМАТИВНАЯ БАЗА (RAG-слой) — встроенные актуальные нормы по темам
# ═══════════════════════════════════════════════════════════════════

NORMS_BY_SECTION = {
    'default': """
АКТУАЛЬНАЯ НОРМАТИВНАЯ БАЗА РФ (2020–2024):
• Градостроительный кодекс РФ (ГрК РФ) — ФЗ №190 от 29.12.2004 (ред. 2024)
• ПП РФ №87 от 16.02.2008 «Состав разделов проектной документации» (ред. 2023)
• ГОСТ Р 21.101-2020 «СПДС. Основные требования к проектной и рабочей документации»
• ГОСТ Р 21.1101-2013 «СПДС. Основные требования к документации»
• СП 48.13330.2019 «Организация строительства»
• ФЗ №384-ФЗ «Технический регламент о безопасности зданий и сооружений»
• ФЗ №123-ФЗ «Технический регламент о требованиях пожарной безопасности»
• МДС 81-35.2004 «Методика определения стоимости строительной продукции»
• Индексы Минстроя 2024 (Приказ №976/пр от 2024)
""",
    'АР': """
НОРМАТИВЫ ДЛЯ АРХИТЕКТУРНЫХ РЕШЕНИЙ:
• СП 118.13330.2022 «Общественные здания и сооружения»
• СП 54.13330.2022 «Здания жилые многоквартирные»
• СП 56.13330.2021 «Производственные здания»
• СП 59.13330.2020 «Доступность зданий для МГН»
• СП 160.1325800.2014 «Здания и комплексы многофункциональные»
• СанПиН 2.1.3684-21 «Санитарно-эпидемиологические требования»
• ГОСТ Р 55654-2013 «Оконные блоки из ПВХ»
• СП 50.13330.2017 «Тепловая защита зданий»
• СП 23-102-2003 «Естественное освещение жилых и общественных зданий»
""",
    'КР': """
НОРМАТИВЫ ДЛЯ КОНСТРУКТИВНЫХ РЕШЕНИЙ:
• СП 20.13330.2017 «Нагрузки и воздействия» (актуализ. СНиП 2.01.07-85*)
• СП 22.13330.2016 «Основания зданий и сооружений»
• СП 24.13330.2021 «Свайные фундаменты»
• СП 63.13330.2018 «Бетонные и железобетонные конструкции»
• СП 16.13330.2017 «Стальные конструкции»
• СП 64.13330.2017 «Деревянные конструкции»
• СП 28.13330.2017 «Защита строительных конструкций от коррозии»
• ГОСТ Р 52544-2006 «Прокат арматурный свариваемый»
• СП 70.13330.2012 «Несущие и ограждающие конструкции»
• Серия 1.020.1-4с «Колонны железобетонные для многоэтажных зданий»
• Серия 1.141.1-23 «Фундаментные балки для производственных зданий»
""",
    'ИОС1': """
НОРМАТИВЫ ДЛЯ ЭЛЕКТРОСНАБЖЕНИЯ:
• ПУЭ изд. 7 «Правила устройства электроустановок»
• СП 256.1325800.2016 «Электроустановки жилых и общественных зданий»
• ГОСТ 32144-2013 «Нормы качества электрической энергии»
• СО 153-34.21.122-2003 «Инструкция по молниезащите»
• ГОСТ Р 50571-4-41-2022 «Электроустановки низкого напряжения»
• СП 6.13130.2021 «Электрооборудование. Требования пожарной безопасности»
• ГОСТ IEC 60947-2-2021 «Аппараты коммутационные»
• МЭК 60364 (принципы расчёта токов КЗ)
• Приказ Минэнерго №204 «Правила технической эксплуатации электроустановок»
• Нормы технологического проектирования НТП ЭПП-94
""",
    'ИОС2': """
НОРМАТИВЫ ДЛЯ ВОДОСНАБЖЕНИЯ И КАНАЛИЗАЦИИ:
• СП 30.13330.2020 «Внутренний водопровод и канализация зданий»
• СП 31.13330.2021 «Водоснабжение. Наружные сети и сооружения»
• СП 32.13330.2018 «Канализация. Наружные сети и сооружения»
• СП 8.13130.2020 «Системы противопожарной защиты. Наружное водоснабжение»
• ГОСТ 21.205-2021 «СПДС. Условные обозначения элементов санитарно-технических систем»
• Серия 3.006.1-2 «Колодцы канализационные»
• Серия 5.905-26.07 «Узлы водопроводных сетей»
• СанПиН 2.1.3684-21 «Требования к воде»
• ГОСТ 539-80 «Трубы чугунные канализационные»
• ГОСТ Р 54475-2011 «Трубы полимерные для систем канализации»
""",
    'ИОС3': """
НОРМАТИВЫ ДЛЯ ОТОПЛЕНИЯ, ВЕНТИЛЯЦИИ И КОНДИЦИОНИРОВАНИЯ:
• СП 60.13330.2020 «Отопление, вентиляция и кондиционирование воздуха»
• СП 50.13330.2017 «Тепловая защита зданий»
• СП 131.13330.2020 «Строительная климатология»
• ГОСТ 30494-2011 «Параметры микроклимата в помещениях»
• СанПиН 1.2.3685-21 «Гигиенические нормативы»
• СП 7.13130.2013 «Отопление, вентиляция и кондиционирование. ПБ»
• ГОСТ Р 53302-2009 «Аппараты теплообменные»
• ГОСТ 21.602-2016 «СПДС. ОВ»
• Пособие к СП 60: расчёт воздухообмена, подбор оборудования
• ВСН 21-77 «Нормы воздухообмена для зданий»
""",
    'ССР': """
НОРМАТИВЫ ДЛЯ СМЕТНОЙ ДОКУМЕНТАЦИИ:
• МДС 81-35.2004 «Методика определения стоимости строительной продукции»
• ГСН 81-05-01-2001 «Сборник сметных норм на строительство временных зданий и сооружений»
• ГСН 81-05-02-2007 «Нормы расходов на непредвиденные работы и затраты»
• Приказ Минстроя №374/пр «Методика применения сметных нормативов»
• ГЕСН-2001 «Государственные элементные сметные нормы»
• ФЕР-2001 «Федеральные единичные расценки»
• Индексы пересчёта в текущие цены (Минстрой, IV кв. 2024)
• НР: стр-во — 112% ФОТ; монтаж — 90% ФОТ; СМР спец. — 95% ФОТ (МДС 81-33.2004)
• СП: стр-во — 65% ФОТ; монтаж — 50% ФОТ; ремонт-стр. — 50% ФОТ (МДС 81-25.2001)
""",
    'ПОС': """
НОРМАТИВЫ ДЛЯ ПРОЕКТА ОРГАНИЗАЦИИ СТРОИТЕЛЬСТВА:
• СП 48.13330.2019 «Организация строительства»
• ГОСТ Р 55654-2013 «Временные здания и сооружения на стройплощадке»
• СНиП 12-03-2001 «Безопасность труда в строительстве. Часть 1»
• СНиП 12-04-2002 «Безопасность труда в строительстве. Часть 2»
• ПОТ РМ-012-2000 «Работы на высоте»
• ЕНиР Е2 «Земляные работы»; ЕНиР Е4 «Монтажные работы»
• РД-11-06-2007 «Схемы строповки»
• ГОСТ 23407-78 «Ограждения инвентарные строительных площадок»
""",
    'ООС': """
НОРМАТИВЫ ДЛЯ ОХРАНЫ ОКРУЖАЮЩЕЙ СРЕДЫ:
• ФЗ №7-ФЗ «Об охране окружающей среды»
• ФЗ №89-ФЗ «Об отходах производства и потребления»
• Приказ МПР №273 «Методы расчёта рассеивания выбросов»
• ГОСТ Р 56707-2015 «Охрана окружающей среды в строительстве»
• СанПиН 2.2.1/2.1.1.1200-03 «Санитарно-защитные зоны»
• Приказ Росприроднадзора №1023 «ФККО» (классификатор отходов)
• ГН 2.1.6.3492-17 «ПДК загрязняющих веществ в атмосфере»
• НДС — нормативы допустимых сбросов в водные объекты
""",
    'МОПБ': """
НОРМАТИВЫ ДЛЯ ПОЖАРНОЙ БЕЗОПАСНОСТИ:
• ФЗ №123-ФЗ «Технический регламент о требованиях пожарной безопасности»
• СП 1.13130.2020 «Эвакуационные пути и выходы»
• СП 2.13130.2020 «Обеспечение огнестойкости объектов защиты»
• СП 3.13130.2009 «Системы оповещения и управления эвакуацией»
• СП 4.13130.2013 «Ограничение распространения пожара»
• СП 5.13130.2009 «Установки пожарной сигнализации и пожаротушения»
• СП 6.13130.2021 «Электроустановки»
• СП 7.13130.2013 «Отопление, вентиляция, кондиционирование»
• СП 8.13130.2020 «Наружное противопожарное водоснабжение»
• СП 10.13130.2020 «Внутренний противопожарный водопровод»
• НПБ 88-2001 «Установки пожаротушения и пожарной сигнализации»
""",
    'ИГИ': """
НОРМАТИВЫ ДЛЯ ИНЖЕНЕРНО-ГЕОЛОГИЧЕСКИХ ИЗЫСКАНИЙ:
• СП 47.13330.2016 «Инженерные изыскания для строительства»
• ГОСТ 25100-2020 «Грунты. Классификация»
• ГОСТ 12248-2020 «Методы лабораторных определений характеристик прочности»
• СП 11-105-97 «Инженерно-геологические изыскания для строительства» (ч. I–VI)
• СП 22.13330.2016 «Основания зданий и сооружений»
• СП 24.13330.2021 «Свайные фундаменты»
• ГОСТ 20522-2012 «Грунты. Методы статистической обработки»
• ГОСТ 12536-2014 «Грунты. Методы лабораторного гранулометрического анализа»
• ГОСТ 31383-2008 «Защита бетонных и железобетонных конструкций от коррозии»
• ГОСТ 9.602-2016 «Сооружения подземные. Защита от коррозии»
""",
    'ИИ': """
НОРМАТИВЫ ДЛЯ ИНЖЕНЕРНЫХ ИЗЫСКАНИЙ (ПОЛНЫЙ КОМПЛЕКС):

─── ОБЩИЕ ───
• СП 47.13330.2016 «Инженерные изыскания для строительства. Основные положения» (обяз.)
• ГОСТ Р 58336-2018 «Изыскания инженерные для строительства»
• ПП РФ №87, Раздел I «Инженерные изыскания» (состав тома)

─── ИГДИ (ГЕОДЕЗИЯ) ───
• СП 47.13330.2016, разд. 5 (топографические съёмки)
• ГОСТ Р 51794-2008 «Системы координат. GPS»
• Инструкция по топографической съёмке М 1:500 — 1:5000 (ГКИНП-02-033-82)
• Правила создания и обновления топографических планов (ГКИНП-ОНТА-02-06-92)
• ЕДИНИЦЫ: га (съёмка), км (ходы), штук (реперы/знаки) — НИКОГДА м³

─── ИГИ (ГЕОЛОГИЯ) ───
• СП 11-105-97, часть I «Общие правила» (табл. 5.1 — категория сложности)
• СП 11-105-97, часть II «Правила для особых условий»
• ГОСТ 25100-2020 «Грунты. Классификация»
• ГОСТ 12248-2020 «Определение характеристик прочности и деформируемости»
• ГОСТ 12536-2014 «Гранулометрический анализ»
• ГОСТ 20522-2012 «Статистическая обработка»
• СП 22.13330.2016, прил. А «Нормативное давление на грунты»
• СП 24.13330.2021 «Свайные фундаменты»
• ЕДИНИЦЫ: пог. м (бурение), штук (скважины/шурфы/зонды), штук (пробы/монолиты) — НИКОГДА м²/м³

─── ИЭИ (ЭКОЛОГИЯ) ───
• СП 47.13330.2016, разд. 8 (инженерно-экологические изыскания)
• ГОСТ Р 58578-2019 «Экологические изыскания»
• СанПиН 2.1.7.1287-03 «Санитарно-эпидемиологические требования к качеству почвы» (табл. отбора проб)
• ГН 2.1.7.2041-06 «ОДК химических веществ в почве»
• СанПиН 2.1.3684-21 «Требования к воде»
• НРБ-99/2009 «Нормы радиационной безопасности»
• ЕДИНИЦЫ: штук (пробы), точек (замеры), км² или га (обследование) — НИКОГДА м³

─── ИГМИ (ГИДРОМЕТЕОРОЛОГИЯ) ───
• СП 47.13330.2016, разд. 9 (инженерно-гидрометеорологические изыскания)
• СП 131.13330.2020 «Строительная климатология» (климатические параметры)
• СП 20.13330.2017 «Нагрузки и воздействия» (ветер, снег, гололёд)
• СП 38.13330.2012 «Нагрузки и воздействия на гидротехнические сооружения»
• РД 52.27.724-2009 «Наставление по краткосрочным прогнозам погоды»
• ЕДИНИЦЫ: текстовые и таблицы (°C, м/с, мм, кгс/м², м БС) — НИКОГДА м³/м²

─── ГЕОТЕХНИКА ───
• СП 22.13330.2016 «Основания зданий и сооружений»
• ГОСТ 31937-2024 «Обследование несущих строительных конструкций»
• СП 13-102-2003 «Правила обследования несущих конструкций зданий и сооружений»
• ЕДИНИЦЫ: м (протяжённость), штук (точки обследования), м² (площадь обследования)

─── АРХЕОЛОГИЯ ───
• ФЗ №73-ФЗ «Об объектах культурного наследия (памятниках истории и культуры)»
• ПП РФ №530 «Государственная историко-культурная экспертиза»
• Закон г. Санкт-Петербурга №820-7 «О границах зон охраны»
• Приказ Минкультуры РФ №3466 «Порядок проведения археологических работ»
• ЕДИНИЦЫ: га (разведка), штук (шурфы/раскопы), этапы (1-2 этапа)

─── МЕТОДИКА РАСЧЁТА ОБЪЁМОВ ИГДИ ───
• Топосъёмка 1:500 — площадь в га. Для застроенной территории: 4 репера на км² (мин.)
  (СП 47.13330.2016, п.5.1.10)
• Съёмка коммуникаций: трубокабелеискатель, ≥14 точек/га

─── МЕТОДИКА РАСЧЁТА ОБЪЁМОВ ИГИ ───
• Категория сложности II (средняя) — для большинства территорий РФ в умеренном климате
  (СП 11-105-97, ч.I, табл.5.1)
• Плотность скважин для кат. II площадных объектов: 1 скв на 0.5–1.0 га
  Принять 1 скв/0.75 га → N = S_га / 0.75 (округлить вверх)
• Глубина скважин при нагрузках до 30 т/м²: 10–12 м ниже подошвы фундамента
  (СП 24.13330.2021, п.5.4)

─── МЕТОДИКА РАСЧЁТА ОБЪЁМОВ ИЭИ ───
• Почвенные пробы (СанПиН 2.1.7.1287-03): ≥5 точек на участок до 10 га,
  глубины 0–0.2 м и 0.5–1.0 м → итого N_точек × 2 проб
• Гамма-съёмка: сеть 50×50 м → N_точек ≈ S_м² / 2500

─── ЗАПРЕЩЕНО ───
• Использовать коэффициенты 0.1 / 0.05 / 0.02 без ссылки на норматив
• Путать единицы: для бурения — пог.м, для съёмки — га, для проб — штук
• Применять «площадь × коэф.» без нормативного основания
• Указывать объёмы изысканий в м³
""",
}

# ═══════════════════════════════════════════════════════════════════
# АГЕНТ 1 — АНАЛИТИК ТЗ
# ═══════════════════════════════════════════════════════════════════
AGENT_ANALYST_PROMPT = """Ты — Аналитик технических заданий с 25-летним опытом в проектировании.
Твоя задача: разобрать ТЗ и извлечь ВСЕ ключевые данные для дальнейшего проектирования.

ВЫДАЙ СТРУКТУРИРОВАННЫЙ АНАЛИЗ В JSON:
{
  "object_type": "тип объекта (жилой/общественный/производственный/линейный/гидротехнический/энергетический)",
  "work_type": "вид работ (НС/реконструкция/КР/ТР)",
  "key_params": {
    "area_m2": число или null,
    "volume_m3": число или null,
    "length_m": число или null,
    "floors": число или null,
    "capacity": "вместимость/мощность или null",
    "location": "адрес/регион",
    "climate_zone": "климатический район (I/II/III/IV + подрайон) или 'не указан'",
    "seismic_zone": "балльность или 'не опасно'",
    "soil_type": "характеристика или 'не указан'"
  },
  "engineering_systems": ["список инженерных систем: электро, вода, канализация, ОВКВ, газ, связь, пожаротушение..."],
  "special_conditions": ["особые условия: ОТЗО, ОКН, агрессивная среда, охранные зоны и пр."],
  "missing_data": ["что не указано в ТЗ — список конкретных пунктов"],
  "assumptions": ["принятые допущения с нормативным обоснованием"],
  "required_sections": ["список разделов по ПП РФ №87 которые нужны для данного объекта"],
  "normative_references": ["ключевые СП/ГОСТ/нормы применимые к данному объекту — минимум 10"],
  "tz_summary": "краткое резюме ТЗ в 3-5 предложениях"
}

ТОЛЬКО JSON, без пояснений."""

# ═══════════════════════════════════════════════════════════════════
# АГЕНТ 2 — ТЕХНИЧЕСКИЙ КООРДИНАТОР (передаёт контекст агенту-специалисту)
# ═══════════════════════════════════════════════════════════════════
AGENT_COORDINATOR_PROMPT = """Ты — Технический координатор проекта (опыт 20 лет).
На основе анализа ТЗ и запрошенного раздела сформируй ТЕХНИЧЕСКОЕ ЗАДАНИЕ ДЛЯ СПЕЦИАЛИСТА.

Определи:
1. Какой специалист разрабатывает данный раздел (архитектор / конструктор / инженер ВК / инженер ЭС / инженер ОВК / сметчик / эколог / пожарный инспектор / геолог)
2. Какие данные от других разделов ему нужны (inter-section dependencies)
3. Конкретные технические параметры которые специалист обязан рассчитать и обосновать
4. Ссылки на конкретные нормативы для данного раздела

Верни JSON:
{
  "specialist_role": "роль специалиста",
  "section_dependencies": ["данные из других разделов: нагрузки/геология/планировка/и т.д."],
  "required_calculations": ["список расчётов: тепловые нагрузки, сечения кабелей, ёмкость резервуаров, и т.д."],
  "required_drawings": ["список чертежей: генплан/план этажа/аксонометрия/схема/профиль"],
  "required_specs": ["спецификации оборудования/материалов"],
  "key_normatives": ["СП/ГОСТ/ПУЭ/СанПиН конкретно для этого раздела с номерами пунктов"],
  "acceptance_criteria": "критерии готовности раздела для прохождения экспертизы"
}

ТОЛЬКО JSON."""


def process_job_async(job_id: str, action: str, combined_text: str, extra_prompt: str, kp_data: dict, section_context: str = ''):
    """Фоновый поток: агентный RAG-подход (4 этапа) → сохраняет результат в БД"""
    conn = None
    try:
        if action == 'generate_kp':
            update_job_stage(job_id, 'Анализирую ТЗ и исходные данные...', 1, 2)
            user_message = f"""СОДЕРЖИМОЕ ЗАГРУЖЕННЫХ ДОКУМЕНТОВ:
{combined_text}

{f'ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ ОТ КЛИЕНТА: {extra_prompt}' if extra_prompt else ''}

Составь коммерческое предложение на основе этих материалов."""
            update_job_stage(job_id, 'Формирую коммерческое предложение...', 2, 2)
            ai_response = call_ai(KP_SYSTEM_PROMPT, user_message)
            result_data = extract_json(ai_response)
        elif action == 'generate_section':
            # ── ЭТАП 1: Аналитик разбирает ТЗ ──────────────────────────────
            update_job_stage(job_id, 'Агент-аналитик разбирает техническое задание...', 1, 4)
            tz_analysis_raw = call_ai(
                AGENT_ANALYST_PROMPT,
                f"ТЕХНИЧЕСКОЕ ЗАДАНИЕ И КОНТЕКСТ:\n{section_context}\n\nДОПОЛНИТЕЛЬНЫЕ МАТЕРИАЛЫ:\n{combined_text[:3000] if combined_text else '—'}",
                max_tokens=2000
            )
            try:
                tz_analysis = extract_json(tz_analysis_raw)
            except Exception:
                tz_analysis = {'tz_summary': tz_analysis_raw[:500], 'normative_references': [], 'missing_data': [], 'assumptions': []}

            # ── ЭТАП 2: Координатор формирует ТЗ для специалиста ─────────────
            update_job_stage(job_id, 'Технический координатор определяет состав раздела...', 2, 4)
            coord_raw = call_ai(
                AGENT_COORDINATOR_PROMPT,
                f"АНАЛИЗ ТЗ:\n{json.dumps(tz_analysis, ensure_ascii=False)}\n\nЗАПРОШЕННЫЙ РАЗДЕЛ:\n{section_context}",
                max_tokens=1500
            )
            try:
                coord_data = extract_json(coord_raw)
            except Exception:
                coord_data = {'key_normatives': [], 'required_calculations': [], 'required_drawings': []}

            # ── ЭТАП 3: Подбор нормативной базы (RAG) ────────────────────────
            update_job_stage(job_id, 'Подбираю нормативную базу (ГОСТ, СП, ПУЭ)...', 3, 4)
            # Определяем раздел по ключевым словам для подбора норм
            section_code_upper = section_context.upper()
            norms_extra = NORMS_BY_SECTION.get('default', '')

            # Маппинг ключевых слов → коды нормативной базы
            SECTION_KEYWORDS = {
                'АР': ['АР', 'АРХИТЕКТУР'],
                'КР': ['КР', 'КОНСТРУКТИВ'],
                'ИОС1': ['ИОС1', 'ЭЛЕКТРОСНАБ', 'ЭО', 'ЭМ', 'ЭЛЕКТР'],
                'ИОС2': ['ИОС2', 'ВОДОСНАБ', 'КАНАЛИЗ', 'ВК', 'ИОС 2'],
                'ИОС3': ['ИОС3', 'ОТОПЛЕН', 'ВЕНТИЛЯЦ', 'КОНДИЦИОН', 'ОВ', 'ОВК', 'ОВКВ'],
                'ССР': ['ССР', 'СМЕТ', 'ЛСР', 'ЛС'],
                'ПОС': ['ПОС', 'ОРГАНИЗАЦ'],
                'ООС': ['ООС', 'ОХРАНА ОКРУЖ', 'ЭКОЛОГИЧ'],
                'МОПБ': ['МОПБ', 'ПБ', 'ПОЖАРН'],
                'ИГИ': ['ИГИ', 'ГЕОЛОГИЧ', 'ГЕОТЕХН'],
                'ИИ': ['ИИ', 'ИГДИ', 'ИЭИ', 'ИГМИ', 'ИЗЫСКАНИ', 'ГЕОДЕЗ', 'ГЕОЛОГИЧ', 'АРХЕОЛОГ', 'ГИДРОМЕТЕО'],
            }
            matched_code = None
            for code, keywords in SECTION_KEYWORDS.items():
                if any(kw in section_code_upper for kw in keywords):
                    matched_code = code
                    break
            if matched_code and matched_code in NORMS_BY_SECTION:
                norms_extra += '\n' + NORMS_BY_SECTION[matched_code]

            # Добавляем нормы из анализа координатора
            if coord_data.get('key_normatives'):
                norms_extra += '\nДОПОЛНИТЕЛЬНЫЕ НОРМАТИВЫ ДЛЯ ДАННОГО РАЗДЕЛА:\n'
                norms_extra += '\n'.join(f'• {n}' for n in coord_data['key_normatives'])

            # ── ЭТАП 4: ГИП генерирует полный раздел ────────────────────────
            update_job_stage(job_id, 'ГИП разрабатывает раздел с чертежами и расчётами...', 4, 4)

            # Обогащённый контекст для финального агента
            enriched_context = f"""
АНАЛИЗ ТЗ (Агент-аналитик):
{json.dumps(tz_analysis, ensure_ascii=False, indent=2)}

ЗАДАНИЕ ДЛЯ СПЕЦИАЛИСТА (Технический координатор):
• Специалист: {coord_data.get('specialist_role', 'ГИП')}
• Обязательные расчёты: {', '.join(coord_data.get('required_calculations', []))}
• Обязательные чертежи: {', '.join(coord_data.get('required_drawings', []))}
• Критерии готовности: {coord_data.get('acceptance_criteria', 'соответствие требованиям экспертизы')}

{norms_extra}

ИСХОДНЫЙ КОНТЕКСТ И ТЗ:
{section_context}
"""

            section_system = """Ты — высококвалифицированный Главный Инженер Проекта (ГИП) с многолетним опытом, владеющий всеми разделами проектирования, нормативной базой РФ (включая Градостроительный кодекс, Постановление №87, ГОСТы, СП, СанПиН, ПУЭ, ведомственные нормы для всех типов объектов — жилых, общественных, производственных, линейных, гидротехнических, энергетических и др.) и передовыми цифровыми инструментами.

Твоя задача — по полученному Техническому заданию (ТЗ) разработать ПОЛНОЦЕННЫЙ раздел проектной документации (стадия «П») и/или рабочей документации (стадия «Р») в объёме, достаточном для прохождения экспертизы и реализации. Ты действуешь как автономная проектная организация — принимаешь все решения самостоятельно, не требуя уточнений.

═══ АНАЛИЗ ИСХОДНЫХ ДАННЫХ ═══
Перед генерацией определи:
• Тип объекта: жилой, общественный, производственный, линейный, гидротехнический, энергетический и т.д.
• Вид работ: новое строительство / реконструкция / капремонт / текущий ремонт / консервация / ликвидация / реставрация
• ТЭП: площадь, объём, протяжённость, мощность, этажность, вместимость
• Климатическая зона и инженерно-геологические условия (если не указаны — принимай типовые для Москвы/ЦФО с явным указанием допущений)
• Инженерное обеспечение: электро, вода, канализация, отопление, вентиляция, газ, связь
• Особые условия: сейсмика, агрессивная среда, ОТЗО, ОКН и т.п.

═══ РАЗДЕЛ "НЕДОСТАЮЩИЕ ДАННЫЕ" ═══
ОБЯЗАТЕЛЬНО в начале каждого документа формируй блок:
<div class="warn-block">
<b>⚠️ ДАННЫЕ, ОТСУТСТВУЮЩИЕ В ТЗ (приняты допущения):</b><br>
Укажи конкретно: что не указано в ТЗ и какое допущение принято (со ссылкой на норматив или типовую практику).
Например: «Климатический район — не указан. Принято: IIВ (Москва), t_нар = -26°C (СП 131.13330.2020)»
</div>

═══ СОСТАВ ДОКУМЕНТАЦИИ ═══
Определяй и формируй согласно ГрК РФ, ПП РФ №87, отраслевым нормам:
• ОКС: ПЗ, СПОЗУ, АР, КР, ИОС1-6, ТХ, ПОС, ПОД, ООС, ПБ/МОПБ, МДИ, ССР, иные разделы
• Линейные: ПЗ, проект полосы отвода, технологические и конструктивные решения, ПОС, ООС
• Ремонт: согласно ВСН или заданию
Для РД: рабочие чертежи марок, ведомости, спецификации, узлы и детали, продольные/поперечные профили

═══ ОБЯЗАТЕЛЬНЫЕ ТРЕБОВАНИЯ К СОДЕРЖАНИЮ ═══

1. РЕАЛЬНЫЕ КОНКРЕТНЫЕ ДАННЫЕ — НИКОГДА не пиши «...», «по проекту», «N значение», «указывается заказчиком», «принимается проектом». Всегда конкретные цифры, марки, ГОСТ, СП.

2. НОРМАТИВНАЯ БАЗА — каждое решение завершается ссылкой: (СП 20.13330.2017, п.6.3) или (ПП РФ №87, п.12).
   Используй актуальную редакцию норм (2020–2024 гг.).

3. СТРУКТУРА по ГОСТ Р 21.101-2020 и ГОСТ Р 21.1101-2013:
   - Нумерация: 1. / 1.1. / 1.1.1.
   - Каждый раздел = текст + расчёты + чертёж + таблица

4. SVG-ЧЕРТЕЖИ — обязательны для: СПОЗУ, АР, КР, ИОС, ГП, схем, разрезов:
   <svg width="700" height="500" viewBox="0 0 700 500" xmlns="http://www.w3.org/2000/svg">
   Включай: здания/сооружения, сети, коммуникации, размерные цепочки, отметки, подписи, условные обозначения.
   Стиль: stroke="#1e3a5f" fill="none", текст font-family="Arial" font-size="11"
   Для линейных объектов — продольный профиль, поперечные сечения.
   ВСЕГДА добавляй легенду/экспликацию в таблице под SVG.

5. СМЕТЫ (ССР, ЛСР, ОС) — по МДС 81-35.2004:
   <table class="data-table"> с колонками: №|Шифр ГЕСН/ФЕР|Наименование работ и затрат|Ед.изм|Кол-во|Прямые затраты (ОЗП+ЭМ+Мат)/ед.|Всего прямых затрат
   Итоговые строки: Прямые затраты → Накладные расходы (105–120% ФОТ) → Сметная прибыль (65% ФОТ) → Итого без НДС → НДС 20% → ВСЕГО
   Для ССР — главы 1–12 МДС 81-35.2004 (подготовка территории, объекты основного назначения, объекты подсобного, объекты энергетики, объекты транспорта и связи, НР, благоустройство, временные здания, прочие, содержание дирекции, проектные работы, резерв).
   Используй реальные расценки ГЕСН/ФЕР 2022–2024 в базисном уровне ТЕР/ФЕР с пересчётом индексом Минстроя.

6. СПЕЦИФИКАЦИИ — таблица: Поз.|Обозначение/марка|Наименование|ГОСТ/ТУ|Ед.изм|Кол-во|Масса ед./общая|Примечание
   Реальные марки: насос К80-50-200, задвижка 30с41нж Ду200, кабель ВВГнг-LS 3×6, трансформатор ТМ-250/10/0,4.

7. ВЕДОМОСТИ ОБЪЁМОВ — таблица: №|Наименование работ|Ед.изм|Формула подсчёта|Объём|Нормативное основание
   Подсчёт по реальным параметрам объекта из ТЗ.

8. РАСЧЁТЫ — в calc-block с формулами и промежуточными результатами:
   <div class="calc-block">
   <b>Расчёт [наименование]:</b><br>
   [Формула с буквенными обозначениями] = [подстановка значений] = [результат с единицами]<br>
   где: [расшифровка каждой переменной с единицами и источником значения]<br>
   <b>Вывод: принимается [решение] по [норматив п.X]</b>
   </div>

9. ТАБЛИЦЫ ГОСТ-ФОРМА:
   <table class="data-table"><thead><tr><th>...</th></tr></thead><tbody><tr><td>...</td></tr><tr class="total-row"><td>ИТОГО</td><td>...</td></tr></tbody></table>

10. ПРЕДУПРЕЖДЕНИЯ И РЕШЕНИЯ:
    <div class="warn-block">⚠️ [Требование норматива / особое условие / ограничение]</div>
    <div class="param-block"><b>Принятое решение:</b> [конкретное техническое решение]</div>
    <div class="info-block">ℹ️ [Допущение / принятый аналог / вариант по импортозамещению]</div>

11. ШТАМП ДОКУМЕНТА:
    <div class="doc-stamp">Лист 1 из N. Раздел: [код] — [наименование]. Объект: [название]. Шифр: [шифр проекта]. Стадия: П/Р. ГИП: ___</div>

12. РАЗДЕЛ СОГЛАСОВАНИЙ (в конце ПЗ):
    Таблица: Наименование согласующего органа|Дата|Номер заключения|Результат
    Пометить: «Условно положительное заключение» (для целей демонстрации)

═══ СПЕЦИФИКА ПО ТИПАМ РАЗДЕЛОВ ═══

ПОЯСНИТЕЛЬНАЯ ЗАПИСКА (ПЗ):
→ Исходные данные (таблица), характеристика площадки, технические условия (реквизиты ТУ), перечень НТД (не менее 15 актуальных норм), описание всех принятых решений, ТЭП (таблица: показатель/ед.изм/значение), перечень допущений, список чертежей

СХЕМА ПЗУ / СПОЗУ / ГП:
→ SVG: ситуационный план (масштаб 1:500), генплан с зонированием, ТЭП благоустройства, баланс территории (таблица: зона/площадь м²/%), роза ветров в SVG, разбивочный чертёж

АРХИТЕКТУРНЫЕ РЕШЕНИЯ (АР):
→ SVG план каждого этажа с координатной сеткой, экспликация помещений (таблица полная), ведомость отделки (таблица: помещение/пол/стены/потолок/материал/норматив), фасады в SVG, разрезы, принципиальные узлы

КОНСТРУКТИВНЫЕ РЕШЕНИЯ (КР):
→ Таблица сбора нагрузок (вид нагрузки/нормат. кН/м²/коэф./расч.), расчёт фундаментов (несущая способность, осадка), схема каркаса в SVG, спецификация арматуры А400 с диаметрами и погонажем, спецификация металлопроката

ЭЛЕКТРОСНАБЖЕНИЕ (ИОС1/ЭО/ЭМ):
→ Однолинейная схема в SVG (КТП-ГРЩ-ЩР-потребители), таблица нагрузок (потребитель/Pуст/Ки/cosφ/Pр/Qр/Sр), выбор кабелей (расчёт сечения по нагреву и потерям), молниезащита (СО 153-34.21.122-2003), заземление (ПУЭ гл.1.7), спецификация

ВОДОСНАБЖЕНИЕ И КАНАЛИЗАЦИЯ (ИОС2/ВК):
→ Аксонометрия В1, Т3, К1 в SVG, расчёт суточного и секундного водопотребления (СП 30.13330.2020), гидравлический расчёт (таблица: участок/q л/с/d мм/v м/с/1000i/hl м), колодцы (типовая серия), спецификация арматуры

ОТОПЛЕНИЕ И ВЕНТИЛЯЦИЯ (ИОС3/ОВ):
→ Расчёт теплопотерь по помещениям (таблица), выбор отопительных приборов (таблица: помещение/Qпот/Qпр/марка/кол-во), аксонометрия системы в SVG, воздушный баланс (таблица приток/вытяжка/кратность), подбор вентиляционного оборудования, шумовой расчёт

ГАЗОСНАБЖЕНИЕ (ИОС5/ГС):
→ Схема газоснабжения в SVG, гидравлический расчёт, подбор оборудования ГРУ, категория по взрывопожаробезопасности (СП 62.13330.2011)

ТЕХНОЛОГИЧЕСКИЕ РЕШЕНИЯ (ТХ):
→ Технологическая схема производства в SVG, ведомость оборудования с привязкой к плану, таблица технологических характеристик, категория производства по взрывопожаробезопасности (СП 12.13130.2009)

ОХРАНА ОКРУЖАЮЩЕЙ СРЕДЫ (ООС):
→ Таблица источников выбросов и ЗВ (вещество/ПДК мр/ПДК сс/код/масса г/с и т/год), расчёт рассеивания (ОНД-90 или Приказ №273), таблица отходов по ФККО (код/наименование/класс/количество/способ обращения), раздел охраны водных объектов

ПОЖАРНАЯ БЕЗОПАСНОСТЬ (ПБ/МОПБ):
→ Характеристика здания по ФЗ-123 (степень огнестойкости, класс конструктивной пожароопасности, функциональная пожароопасность), эвакуационные пути (таблица: путь/длина/ширина/соответствие), система АПС, СОУЭ, АУПТ, АУПЗ — таблица оборудования, план эвакуации в SVG

ИНЖЕНЕРНЫЕ ИЗЫСКАНИЯ (ИГДИ, ИГИ, ИЭИ, ИГМИ, ИИ — любой раздел изысканий):

ОБЯЗАТЕЛЬНАЯ СТРУКТУРА ТОМА ИЗЫСКАНИЙ (согласно СП 47.13330.2016 и ПП РФ №87):
1. Инженерно-геодезические изыскания (ИГДИ)
2. Инженерно-геологические изыскания (ИГИ)
3. Инженерно-экологические изыскания (ИЭИ)
4. Инженерно-гидрометеорологические изыскания (ИГМИ)
5. Археологические изыскания (при наличии требования в ТЗ или в зонах ОКН)
6. Обследование строительных конструкций существующих сооружений (если объект реконструкции)
7. Технический отчёт сводный с таблицей объёмов и заключениями

ДЛЯ КАЖДОГО ПОДРАЗДЕЛА ОБЯЗАТЕЛЬНО:
• Цель и задачи подраздела
• Состав работ со ссылками на конкретные пункты СП 47.13330.2016
• Расчёт объёмов работ СТРОГО по нормативам (см. ниже)
• Методика полевых и камеральных работ
• Ожидаемые результаты с таблицами

═══ ПРАВИЛЬНЫЕ ЕДИНИЦЫ ИЗМЕРЕНИЯ ═══
• ИГДИ (геодезия): га (площадь съёмки), км (протяжённость ходов), штук (реперы/знаки/пикеты)
• ИГИ (геология): пог.м (бурение), штук (скважины, шурфы, зонды, пробы, монолиты)
• ИЭИ (экология): штук (пробы почвы/воды/воздуха), точек (замеры радиации/шума), га (гамма-съёмка)
• ИГМИ: текстовые данные и таблицы (°C, м/с, мм, кгс/м², м БС) — БЕЗ кубометров
• НИКОГДА для изысканий не использовать: м³ (объём изысканий), м² (площадь бурения)

═══ РАСЧЁТ ОБЪЁМОВ СТРОГО ПО НОРМАТИВАМ ═══

ИГДИ — топосъёмка 1:500:
→ Площадь съёмки = площадь участка + буферная зона 50 м = S_га
→ Реперы: ≥4 на 1 км² застроенной территории (СП 47.13330.2016, п.5.1.10)
   Для S_га: N_реп = max(4, ceil(S_га/100 × 4))
→ Ходы: ориентировочно периметр участка + внутренние ходы ≈ 2–4 км
→ Съёмка коммуникаций: трубокабелеискатель, ≥14 точек/га

ИГИ — бурение:
→ Кат. сложности: I — простая (равнина, однородные грунты), II — средняя (типовая для РФ), III — сложная (слабые грунты, карсты, оползни)
→ Плотность скважин (СП 11-105-97, ч.I, табл.5.1):
   Кат. I: 1 скв / 1.5 га; Кат. II: 1 скв / 0.75 га; Кат. III: 1 скв / 0.5 га
   Формула: N_скв = S_га / d_га (округлить вверх), но не менее 3
→ Глубина: нагрузки до 10 т/м² → 8–10 м; до 30 т/м² → 10–15 м; более → 20+ м
   (СП 24.13330.2021, п.5.4)
→ Объём бурения: L_общ = N_скв × H_скв (пог.м)

ИЭИ — отбор проб:
→ Почва (СанПиН 2.1.7.1287-03): ≥5 точек на ≤10 га; глубины 0–0.2 м и 0.5–1.0 м
   Итого: N_т × 2 проб
→ Грунтовые воды: ≥3 пробы из разных скважин при наличии водоносного горизонта
→ Гамма-съёмка: сеть 50×50 м → N_точек ≈ S_м² / 2500

ИГМИ:
→ Сбор данных метеостанции (ближайшей к объекту)
→ Климатические параметры по СП 131.13330.2020 (t_нар, t_хол5, снеговая/ветровая нагрузки)
→ Гидрологические характеристики: уровни воды, расходы, ледовый режим, нагонные явления
→ РЕЗУЛЬТАТ: текстовый технический отчёт с таблицами — без численных «объёмов работ в м²/м³»

═══ ИТОГОВАЯ ТАБЛИЦА ОБЪЁМОВ (обязательна в конце тома) ═══
| № | Вид изысканий | Ед. изм. | Объём | Нормативное основание |
— Использовать ТОЛЬКО правильные единицы для каждого вида

ВАЖНО: Числа в разных подразделах должны быть согласованы (одинаковое кол-во скважин, одна площадь участка, единый адрес объекта).

ТАКЖЕ: Таблица физико-механических свойств грунтов (ИГЭ/горизонт/γ кН/м³/E МПа/φ°/с кПа/IL), литологическая колонка скважины в SVG, карта ИГЭ в SVG, рекомендации по фундаментам, гидрогеологический раздел (УГВ, агрессивность воды по ГОСТ 31383-2008)

СМЕТА (ССР, ЛСР):
→ Полная локальная смета минимум 15 позиций по ГЕСН/ФЕР, главы ССР 1–12, сводная таблица по этапам строительства. Итоговые показатели: стоимость 1 м² общей площади, стоимость 1 м³ строительного объёма.

ПОС:
→ Таблица распределения объёмов работ по периодам (квартал/год), схема стройгенплана в SVG (временные здания, склады, КПП, ВЗУ, башенный кран), ведомость потребности в механизмах, рабочей силе, материалах по месяцам

═══ УНИВЕРСАЛЬНЫЕ ПРАВИЛА САМОПРОВЕРКИ (применять ко ВСЕМ разделам) ═══

ЕДИНИЦЫ ИЗМЕРЕНИЯ — ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА:
• Давление: Па, кПа, МПа (НЕ кгс/см² без перевода), нагрузки: кН/м² или кгс/м² (единообразно в документе)
• Расходы воды/стоков: м³/ч, л/с, м³/сут (НЕ смешивать в одном расчёте)
• Площади: м² или га (1 га = 10 000 м²) — для земельных участков предпочтительно га
• Длины: м (НЕ смешивать м и км в одной таблице без явного обозначения)
• Объёмы строительные: м³ (НЕ для объёмов буровых работ — там пог.м)
• Электрические величины: кВт (мощность), кВА (полная мощность), А (ток), кВ (высокое напряжение), В (низкое)
• Температуры: °C (НЕ K без явного указания)

НОРМАТИВНАЯ БАЗА — ПРОВЕРИТЬ:
• Каждое расчётное значение должно иметь ссылку: (СП XX.XXXXXX.XXXX, п.X.X)
• Ссылаться ТОЛЬКО на актуальные редакции (не на отменённые СНиП без оговорки «актуализированная редакция»)
• Коэффициенты без нормативного обоснования — ЗАПРЕЩЕНЫ

РАСЧЁТЫ — ЛОГИЧЕСКАЯ ПРОВЕРКА:
• Промежуточные и итоговые значения должны быть численно согласованы
• Нагрузки в КР = нагрузкам, принятым в ИОС (нет противоречий между разделами)
• Расходы воды в ТЗ/ТХ = расходам в ИОС2 (ВК)
• Площадь застройки в АР ≈ площади оснований в КР
• Установленная мощность в ИОС1 = нагрузке питающей подстанции

ДОПУЩЕНИЯ — ТРЕБОВАНИЯ:
• Все допущения собирать в блок <div class="warn-block"> В НАЧАЛЕ документа
• Каждое допущение: ЧТО не указано → ЧТО принято → НА ОСНОВАНИИ ЧЕГО (норматив или типовая практика)
• Пример: «Климатический район — не указан. Принято: IIВ, t_нар = -26°C (СП 131.13330.2020, табл. 3.1)»

ЛОГИЧЕСКАЯ НЕПРОТИВОРЕЧИВОСТЬ:
• Один объект = одни ТЭП во всём документе (площадь/объём/высота не меняются между разделами)
• Один адрес и кадастровый номер
• Если в ТЗ указан климатический район — использовать его, не придумывать другой
• Если в ТЗ указана производительность/мощность — использовать её во всех расчётах

═══ ИМПОРТОЗАМЕЩЕНИЕ ═══
Используй отечественное оборудование и материалы:
Вентиляция: Арктос, VentMachine, Systemair-RU; Насосы: Grundfos-RU, ГРЦ «Нептун»; Кабели: Камкабель, Холдинг Кабельный Альянс; Трубы: ТМК, ЧТПЗ, Полипластик; Металл: НЛМК, ММК, Северсталь.

═══ ФОРМАТ ОТВЕТА ═══
Только HTML без <!DOCTYPE html>. Минимум 3000 слов.
Обязательные теги: h1 (шифр+название+стадия), h2 (разделы), h3 (подразделы), h4 (пункты), table.data-table, svg (чертежи), div.calc-block (расчёты), div.warn-block (предупреждения), div.param-block (решения), div.info-block (допущения).
Начинай с div.warn-block с перечнем отсутствующих данных и принятых допущений."""
            ai_response = call_ai(section_system, enriched_context, max_tokens=16000)
            result_data = {
                'content': ai_response,
                'agent_analysis': tz_analysis,
                'agent_coordination': coord_data
            }
        else:
            user_message = f"""СОДЕРЖИМОЕ ЗАГРУЖЕННЫХ ДОКУМЕНТОВ:
{combined_text}

{f'ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ: {extra_prompt}' if extra_prompt else ''}
"""
            if kp_data:
                user_message += f"\nКОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ:\n{json.dumps(kp_data, ensure_ascii=False)}"
            user_message += "\n\nСоставь дорожную карту реализации проекта."
            ai_response = call_ai(ROADMAP_SYSTEM_PROMPT, user_message)
            result_data = extract_json(ai_response)

        result_json = json.dumps(result_data, ensure_ascii=False)

        conn = get_db()
        cur = conn.cursor()
        cur.execute(
            "UPDATE kp_jobs SET status='done', result=%s, updated_at=NOW() WHERE id=%s",
            (result_json, job_id)
        )
        conn.commit()
    except Exception as e:
        try:
            if conn is None:
                conn = get_db()
            cur = conn.cursor()
            cur.execute(
                "UPDATE kp_jobs SET status='error', error=%s, updated_at=NOW() WHERE id=%s",
                (str(e), job_id)
            )
            conn.commit()
        except Exception:
            pass
    finally:
        if conn:
            conn.close()


def handler(event: dict, context) -> dict:
    """Генерация КП через ИИ — асинхронная очередь (start_job → check_job) чтобы обойти таймаут"""

    if event.get('httpMethod') == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type, X-Authorization',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }

    if event.get('httpMethod') != 'POST':
        return {
            'statusCode': 405,
            'headers': {'Access-Control-Allow-Origin': '*'},
            'body': json.dumps({'error': 'Method not allowed'})
        }

    body = json.loads(event.get('body', '{}'))
    action = body.get('action', '')

    CORS = {'Access-Control-Allow-Origin': '*', 'Content-Type': 'application/json'}

    if action == 'ping':
        return {'statusCode': 200, 'headers': CORS, 'body': json.dumps({'status': 'ok'})}

    # Проверка статуса задачи
    if action == 'check_job':
        job_id = body.get('job_id')
        conn = get_db()
        cur = conn.cursor()
        cur.execute("SELECT status, result, error, progress FROM kp_jobs WHERE id=%s", (job_id,))
        row = cur.fetchone()
        conn.close()
        if not row:
            return {'statusCode': 404, 'headers': CORS, 'body': json.dumps({'error': 'Job not found'})}
        status, result, error, progress = row
        resp = {'status': status}
        if progress:
            try:
                resp['progress'] = json.loads(progress)
            except Exception:
                resp['progress'] = {'stage': progress}
        if status == 'done' and result:
            resp['data'] = json.loads(result)
        if status == 'error':
            resp['error'] = error
        return {'statusCode': 200, 'headers': CORS, 'body': json.dumps(resp, ensure_ascii=False)}

    # Запуск новой задачи
    if action not in ('generate_kp', 'generate_roadmap', 'generate_section'):
        return {'statusCode': 400, 'headers': CORS, 'body': json.dumps({'error': f'Unknown action: {action}'})}

    extra_prompt = body.get('extra_prompt', '')
    files_text = body.get('files_text', '')
    kp_data = body.get('kp_data', None)
    files_b64 = body.get('files_b64', [])
    section_context = body.get('context', '')

    # Парсинг файлов
    parsed_texts = []
    for f in files_b64:
        name = f.get('name', '')
        b64 = f.get('data', '')
        raw = base64.b64decode(b64)
        if name.lower().endswith('.pdf'):
            text = extract_text_from_pdf(raw)
        elif name.lower().endswith('.docx'):
            text = extract_text_from_docx(raw)
        else:
            text = raw.decode('utf-8', errors='replace')
        parsed_texts.append(f'=== ФАЙЛ: {name} ===\n{text}')

    combined_text = '\n\n'.join(parsed_texts) if parsed_texts else files_text

    # Сохранить задачу в БД
    input_data = json.dumps({'action': action, 'extra_prompt': extra_prompt}, ensure_ascii=False)
    conn = get_db()
    cur = conn.cursor()
    cur.execute(
        "INSERT INTO kp_jobs (action, status, input_data) VALUES (%s, 'processing', %s) RETURNING id",
        (action, input_data)
    )
    job_id = str(cur.fetchone()[0])
    conn.commit()
    conn.close()

    # Запустить фоновый поток
    t = threading.Thread(
        target=process_job_async,
        args=(job_id, action, combined_text, extra_prompt, kp_data, section_context),
        daemon=True
    )
    t.start()

    return {
        'statusCode': 202,
        'headers': CORS,
        'body': json.dumps({'job_id': job_id, 'status': 'processing'})
    }