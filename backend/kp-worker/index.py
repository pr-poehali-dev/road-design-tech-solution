"""KP Worker — обрабатывает один job: вызывает DeepSeek и сохраняет в kp_jobs.
Вызывается fire-and-forget из фронта после создания job."""
import json
import os
import httpx
import psycopg2


def get_db():
    return psycopg2.connect(os.environ['DATABASE_URL'])


def call_ai(system_prompt: str, user_message: str) -> str:
    api_key = os.environ.get('OPENROUTER_API_KEY', '')
    response = httpx.post(
        'https://openrouter.ai/api/v1/chat/completions',
        headers={
            'Authorization': f'Bearer {api_key}',
            'Content-Type': 'application/json',
        },
        json={
            'model': 'deepseek/deepseek-chat',
            'messages': [
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_message}
            ],
            'max_tokens': 8000,
            'temperature': 0.2,
        },
        timeout=200.0
    )
    result = response.json()
    if 'choices' not in result:
        error_msg = result.get('error', {}).get('message', str(result))
        raise Exception(f"OpenRouter error: {error_msg}")
    return result['choices'][0]['message']['content']


def extract_json(text: str) -> dict:
    text = text.strip()
    if '```json' in text:
        text = text.split('```json')[1].split('```')[0].strip()
    elif '```' in text:
        text = text.split('```')[1].split('```')[0].strip()
    return json.loads(text)


PRICE_LIST = [
    {"code": "ОП-ОКС.БЗУ", "name": "Благоустройство земельного участка (БЗУ под ключ)", "unit": "га", "price_per_unit": 500000},
    {"code": "ОП-ППТ госконтракт", "name": "ППТ, госконтракт", "unit": "га", "price_per_unit": 450000},
    {"code": "ОП-ППТ коммерческий", "name": "ППТ, коммерческий контракт", "unit": "га", "price_per_unit": 1500000},
    {"code": "ОП-ПМТ госконтракт", "name": "ПМТ, госконтракт", "unit": "га", "price_per_unit": 450000},
    {"code": "ОП-ПМТ коммерческий", "name": "ПМТ, коммерческий контракт", "unit": "га", "price_per_unit": 1500000},
    {"code": "ИИ-ИГДИ", "name": "Инженерно-геодезические изыскания", "unit": "га", "price_per_unit": 40000},
    {"code": "ИИ-ИЭИ", "name": "Инженерно-экологические изыскания", "unit": "га", "price_per_unit": 65000},
    {"code": "ИИ-ОБМ", "name": "Обмерные работы", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ПГО до 100", "name": "ПГО до 100 га", "unit": "га", "price_per_unit": 24000},
    {"code": "ОП-ПГО 100-500", "name": "ПГО 100–500 га", "unit": "га", "price_per_unit": 23000},
    {"code": "ОП-ПГО 500-2000", "name": "ПГО 500–2000 га", "unit": "га", "price_per_unit": 22000},
    {"code": "ОП-ПГО 2000-5000", "name": "ПГО 2000–5000 га", "unit": "га", "price_per_unit": 21000},
    {"code": "ОП-ПГО более 5000", "name": "ПГО более 5000 га", "unit": "га", "price_per_unit": 20000},
    {"code": "СОПГЭ", "name": "Сопровождение экспертизы (ГЭ/НГЭ)", "unit": "комплект", "price_per_unit": 200000},
    {"code": "ОП-ОКС.НС до 100", "name": "ОКС — новое строительство, до 100 м³", "unit": "м³", "price_per_unit": 5000},
    {"code": "ОП-ОКС.НС 100-500", "name": "ОКС — новое строительство, 100–500 м³", "unit": "м³", "price_per_unit": 4000},
    {"code": "ОП-ОКС.НС 500-5000", "name": "ОКС — новое строительство, 500–5000 м³", "unit": "м³", "price_per_unit": 2000},
    {"code": "ОП-ОКС.НС более 5000", "name": "ОКС — новое строительство, более 5000 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.РЕК до 100", "name": "ОКС — реконструкция, до 100 м³", "unit": "м³", "price_per_unit": 3000},
    {"code": "ОП-ОКС.РЕК 100-500", "name": "ОКС — реконструкция, 100–500 м³", "unit": "м³", "price_per_unit": 2500},
    {"code": "ОП-ОКС.РЕК 500-5000", "name": "ОКС — реконструкция, 500–5000 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.РЕК более 5000", "name": "ОКС — реконструкция, более 5000 м³", "unit": "м³", "price_per_unit": 1000},
    {"code": "ОП-ОКС.КР до 100", "name": "ОКС — капитальный ремонт, до 100 м³", "unit": "м³", "price_per_unit": 2000},
    {"code": "ОП-ОКС.КР 100-500", "name": "ОКС — капитальный ремонт, 100–500 м³", "unit": "м³", "price_per_unit": 1500},
    {"code": "ОП-ОКС.КР 500-5000", "name": "ОКС — капитальный ремонт, 500–5000 м³", "unit": "м³", "price_per_unit": 1000},
    {"code": "ОП-ОКС.КР более 5000", "name": "ОКС — капитальный ремонт, более 5000 м³", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ОКС.ТР до 100", "name": "ОКС — текущий ремонт, до 100 м³", "unit": "м³", "price_per_unit": 500},
    {"code": "ОП-ОКС.ТР 100-500", "name": "ОКС — текущий ремонт, 100–500 м³", "unit": "м³", "price_per_unit": 450},
    {"code": "ОП-ОКС.ТР 500-5000", "name": "ОКС — текущий ремонт, 500–5000 м³", "unit": "м³", "price_per_unit": 300},
    {"code": "ОП-ОКС.ТР более 5000", "name": "ОКС — текущий ремонт, более 5000 м³", "unit": "м³", "price_per_unit": 250},
    {"code": "ОП-ЛО.ИЛО до 1000", "name": "Локальные очистные сооружения, до 1000 м³/сут", "unit": "м³/сутки", "price_per_unit": 2300},
    {"code": "ОП-ЛО.ИЛО 1000-5000", "name": "Локальные очистные сооружения, 1000–5000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1900},
    {"code": "ОП-ЛО.ИЛО 5000-10000", "name": "Локальные очистные сооружения, 5000–10000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1500},
    {"code": "ОП-ЛО.ИЛО более 10000", "name": "Локальные очистные сооружения, более 10000 м³/сут", "unit": "м³/сутки", "price_per_unit": 1100},
    {"code": "ОП-АН", "name": "Авторский надзор", "unit": "месяц", "price_per_unit": 100000},
    {"code": "ОП-НТС", "name": "Научно-техническое сопровождение (НТС)", "unit": "месяц", "price_per_unit": 1500000},
    {"code": "ОП-ТНЗ 1 сотрудник", "name": "Технадзор, 1 сотрудник", "unit": "чел.-месяц", "price_per_unit": 350000},
    {"code": "ОП-ТНЗ 2-5 сотрудников", "name": "Технадзор, 2–5 сотрудников", "unit": "чел.-месяц", "price_per_unit": 300000},
    {"code": "ОП-ТНЗ 5-10 сотрудников", "name": "Технадзор, 5–10 сотрудников", "unit": "чел.-месяц", "price_per_unit": 250000},
    {"code": "ОП-ТНЗ более 10 сотрудников", "name": "Технадзор, более 10 сотрудников", "unit": "чел.-месяц", "price_per_unit": 200000},
    {"code": "ОП-ЮРЗ 1 сотрудник", "name": "Юридическое сопровождение, 1 юрист", "unit": "чел.-месяц", "price_per_unit": 300000},
    {"code": "ОП-ЮРЗ 2-5 сотрудников", "name": "Юридическое сопровождение, 2–5 юристов", "unit": "чел.-месяц", "price_per_unit": 250000},
    {"code": "ОП-ЮРЗ 5-10 сотрудников", "name": "Юридическое сопровождение, 5–10 юристов", "unit": "чел.-месяц", "price_per_unit": 200000},
]

PRICE_LIST_STR = json.dumps(PRICE_LIST, ensure_ascii=False)

KP_SYSTEM_PROMPT = f"""Ты — эксперт по составлению коммерческих предложений для проектно-инжиниринговой компании.
На основе предоставленных документов (ТЗ, технические задания, файлы) составь детальное Коммерческое Предложение (КП) на русском языке.

ПРАЙС-ЛИСТ компании (используй ТОЛЬКО эти позиции для расчёта стоимости):
{PRICE_LIST_STR}

АЛГОРИТМ СОСТАВЛЕНИЯ КП (выполняй строго по шагам):

ШАГ 1 — Извлечь из ТЗ ключевые параметры:
- Тип объекта и наименование
- Вид работ: новое строительство (НС) / реконструкция (РЕК) / капремонт (КР)
- Площадь участка изысканий в га (найди в ТЗ явно или рассчитай из размеров)
- Строительный объём новых/реконструируемых сооружений в м³ (найди или оцени по аналогам)
- Наличие требований к экспертизам (ГЭЭ, госэкспертиза)
- Наличие авторского надзора, НТС

ШАГ 2 — Подобрать позиции из прайса:

ИНЖЕНЕРНЫЕ ИЗЫСКАНИЯ — включай ВСЕ виды изысканий, которые упомянуты в ТЗ:
- ИИ-ИГДИ (геодезия): если в ТЗ есть ИГДИ → объём = площадь_га, цена = 40000/га. Всегда включать для строительных объектов!
- ИИ-ИЭИ (экология): если в ТЗ есть ИЭИ → объём = площадь_га, цена = 65000/га. Всегда включать!
- ИИ-ОБМ (обмерные работы): если в ТЗ есть обследование/обмеры существующих конструкций → объём = оцени в м³ по описанию сооружений, цена = 500/м³
- Инженерно-геологические (ИГИ): если упомянуты в ТЗ → позиции нет в прайсе, ставь ориентировочно 1 000 000 руб (notes: "ориентировочно, не в прайсе")
- Инженерно-гидрометеорологические (ИГМИ): если упомянуты → 500 000 руб (notes: "ориентировочно, не в прайсе")
- Археологические изыскания: если упомянуты → 2 000 000 руб (notes: "ориентировочно, не в прайсе, включает ГИКЭ и согласование с КГИОП")

ПРОЕКТИРОВАНИЕ ОКС:
- Новое строительство: выбери диапазон по volume_m3:
  * до 100 м³ → "ОП-ОКС.НС до 100", 5000 руб/м³
  * 100–500 м³ → "ОП-ОКС.НС 100-500", 4000 руб/м³
  * 500–5000 м³ → "ОП-ОКС.НС 500-5000", 2000 руб/м³
  * более 5000 м³ → "ОП-ОКС.НС более 5000", 1500 руб/м³
- Реконструкция: "ОП-ОКС.РЕК ..." соответствующий диапазон (до 100: 3000, 100-500: 2500, 500-5000: 1500, >5000: 1000)
- Капремонт: "ОП-ОКС.КР ..." (до 100: 2000, 100-500: 1500, 500-5000: 1000, >5000: 500)
- ВАЖНО: если volume_m3 не указан → ОЦЕНИ по типу объекта (НЕ СТАВЬ 0!):
  * Промышленные/технологические сооружения: ~20000-50000 м³
  * Административное здание: ~5000-10000 м³

ЭКСПЕРТИЗЫ:
- СОПГЭ: 1 комплект = 200000 руб — включать если требуется госэкспертиза ИЛИ ГЭЭ

ДОПОЛНИТЕЛЬНЫЕ (только если ЯВНО указано):
- ОП-АН (авторский надзор): объём = кол-во месяцев строительства, 100000/мес
- ОП-НТС (научно-техническое сопровождение): ТОЛЬКО если в ТЗ ЯВНО написано "НТС" или "научно-техническое сопровождение". НЕ включать если ТЗ просто упоминает стеснённые условия или сложность объекта! Объём = кол-во месяцев, 1500000/мес.

ШАГ 3 — Рассчитать каждую строку:
total = volume × price_per_unit (ПРОВЕРИТЬ арифметику!)
Сумма в notes для позиций не из прайса.

ШАГ 4 — Посчитать total_sum:
Сложить ВСЕ строки total включая позиции не из прайса. Перепроверить сумму.

ЭТАЛОННЫЙ ПРИМЕР расчёта (объект 6.9 га, 25000 м³ НС, с ГЭЭ, с АН 18 мес, с ИГИ, ИГМИ, Арх):
- ИИ-ИГДИ: 6.9 × 40000 = 276000
- ИИ-ИЭИ: 6.9 × 65000 = 448500
- ИГИ (не в прайсе): 1000000 (ориентировочно)
- ИГМИ (не в прайсе): 500000 (ориентировочно)
- Археологические (не в прайсе): 2000000 (ориентировочно)
- ИИ-ОБМ: 2000 м³ × 500 = 1000000
- ОП-ОКС.НС более 5000: 25000 × 1500 = 37500000
- СОПГЭ: 1 × 200000 = 200000
- ОП-АН: 18 × 100000 = 1800000
- ИТОГО БАЗОВЫЙ = 5224500 (изыскания) + 37500000 (проектирование) + 200000 (экспертиза) = 42924500
- С АН = 42924500 + 1800000 = 44724500

СТРУКТУРА КП:
1. Титульная страница: название, клиент, дата, объект, вид работ, основание, источник финансирования
2. Краткое резюме: суть проекта 3-5 предложений
3. Разделы работ: "Инженерные изыскания", "Проектирование", "Сопровождение экспертиз", "Дополнительные услуги"
4. В каждом разделе — таблица: Код | Наименование | Ед. | Объём | Цена за ед. | Итого
5. Итоговая стоимость с разбивкой: базовый пакет и опции
6. Сроки реализации по этапам
7. Условия оплаты (аванс 40%, промежуточные платежи, финальный расчёт)
8. Особые условия и исключения

Отвечай ТОЛЬКО JSON в формате:
{{
  "kp": {{
    "title": "...",
    "client": "...",
    "date": "...",
    "object_name": "...",
    "work_type": "...",
    "summary": "...",
    "sections": [{{"name": "...", "items": [{{"code": "...", "name": "...", "unit": "...", "volume": 0, "price_per_unit": 0, "total": 0, "notes": "..."}}]}}],
    "total_sum": 0,
    "total_sum_words": "...",
    "timeline": [{{"phase": "...", "duration": "...", "description": "..."}}],
    "payment_conditions": ["..."],
    "special_conditions": ["..."],
    "validity": "30 дней"
  }}
}}"""

ROADMAP_SYSTEM_PROMPT = """Ты — опытный менеджер проектов. На основе технического задания и коммерческого предложения составь подробную дорожную карту реализации проекта.

СТРУКТУРА ДОРОЖНОЙ КАРТЫ:
1. Обзор проекта: Цели, ключевые результаты
2. Этапы реализации: Детальная разбивка по фазам
3. Ключевые вехи: Контрольные точки и критерии приёмки
4. Риски и митигация: Основные риски и пути их снижения
5. Команда и ресурсы: Необходимые специалисты и ресурсы
6. Критический путь: Наиболее важные зависимости

Отвечай ТОЛЬКО JSON в формате:
{
  "roadmap": {
    "project_name": "...",
    "total_duration": "...",
    "overview": "...",
    "phases": [{"id": 1, "name": "...", "duration": "...", "start_week": 1, "end_week": 4, "tasks": ["..."], "deliverables": ["..."], "responsible": "..."}],
    "milestones": [{"week": 4, "name": "...", "criteria": "..."}],
    "risks": [{"risk": "...", "probability": "высокая/средняя/низкая", "impact": "высокий/средний/низкий", "mitigation": "..."}],
    "team": [{"role": "...", "count": 1, "tasks": "..."}],
    "critical_path": ["..."]
  }
}"""


def handler(event: dict, context) -> dict:
    """Воркер: получает job_id + текст документа, вызывает DeepSeek, сохраняет результат в kp_jobs"""

    CORS = {'Access-Control-Allow-Origin': '*', 'Content-Type': 'application/json'}

    if event.get('httpMethod') == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }

    body = json.loads(event.get('body', '{}'))
    job_id = body.get('job_id')
    combined_text = body.get('combined_text', '')
    extra_prompt = body.get('extra_prompt', '')
    action = body.get('action', 'generate_kp')
    kp_data = body.get('kp_data', None)

    if not job_id:
        return {'statusCode': 400, 'headers': CORS, 'body': json.dumps({'error': 'job_id required'})}

    conn = None
    try:
        if action == 'generate_kp':
            user_message = f"""СОДЕРЖИМОЕ ЗАГРУЖЕННЫХ ДОКУМЕНТОВ:
{combined_text}

{f'ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ ОТ КЛИЕНТА: {extra_prompt}' if extra_prompt else ''}

Составь коммерческое предложение на основе этих материалов."""
            ai_response = call_ai(KP_SYSTEM_PROMPT, user_message)
        else:
            user_message = f"""СОДЕРЖИМОЕ ЗАГРУЖЕННЫХ ДОКУМЕНТОВ:
{combined_text}

{f'ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ: {extra_prompt}' if extra_prompt else ''}
"""
            if kp_data:
                user_message += f"\nКОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ:\n{json.dumps(kp_data, ensure_ascii=False)}"
            user_message += "\n\nСоставь дорожную карту реализации проекта."
            ai_response = call_ai(ROADMAP_SYSTEM_PROMPT, user_message)

        result_data = extract_json(ai_response)
        result_json = json.dumps(result_data, ensure_ascii=False)

        conn = get_db()
        cur = conn.cursor()
        cur.execute(
            "UPDATE kp_jobs SET status='done', result=%s, updated_at=NOW() WHERE id=%s",
            (result_json, job_id)
        )
        conn.commit()
        return {'statusCode': 200, 'headers': CORS, 'body': json.dumps({'status': 'done'})}

    except Exception as e:
        try:
            if conn is None:
                conn = get_db()
            cur = conn.cursor()
            cur.execute(
                "UPDATE kp_jobs SET status='error', error=%s, updated_at=NOW() WHERE id=%s",
                (str(e), job_id)
            )
            conn.commit()
        except Exception:
            pass
        return {'statusCode': 200, 'headers': CORS, 'body': json.dumps({'status': 'error', 'error': str(e)})}
    finally:
        if conn:
            conn.close()
